<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«‹åˆ©é¤åŠ - ç·šä¸Šé»é¤ (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    <!-- ä¿®æ­£ï¼šåŠ å…¥ plugins=typography ä»¥æ”¯æ´ Markdown æ’ç‰ˆ -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <!-- Markdown Parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // å¼•å…¥ Firebase æ ¸å¿ƒèˆ‡åˆ†æ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-analytics.js";
        
        // å¼•å…¥ Firestore è³‡æ–™åº«èˆ‡ Auth é©—è­‰
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, getDocs, writeBatch, where } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // æ‚¨çš„ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyAOeqs-8K5q0NH3IL996yIVNoBk1DWn5fc",
            authDomain: "myorder-lili.firebaseapp.com",
            projectId: "myorder-lili",
            storageBucket: "myorder-lili.firebasestorage.app",
            messagingSenderId: "693715367698",
            appId: "1:693715367698:web:08e4046604c80a2c0ca5cb",
            measurementId: "G-JXJJRWZP85"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let isFirebaseReady = false;

        // --- åˆå§‹åŒ–æµç¨‹ ---
        // å˜—è©¦åŒ¿åç™»å…¥ï¼Œè‹¥å¤±æ•—å‰‡å˜—è©¦ç›´æ¥é€£ç·š (é‡å°å…¬é–‹è¦å‰‡çš„è³‡æ–™åº«)
        async function initApp() {
            try {
                await signInAnonymously(auth);
                console.log("âœ… Firebase ç™»å…¥æˆåŠŸ (åŒ¿åæ¨¡å¼)");
                isFirebaseReady = true;
                setupRealtimeListener();
            } catch (error) {
                console.warn("âš ï¸ Firebase é©—è­‰å¤±æ•—ï¼Œå˜—è©¦ä»¥å…¬é–‹æ¨¡å¼é€£ç·š...", error.code);
                
                if (error.code === 'auth/configuration-not-found' || error.code === 'auth/operation-not-allowed') {
                    setTimeout(() => {
                        showToast("âš ï¸ è«‹è‡³ Firebase Console é–‹å•Ÿ 'åŒ¿åç™»å…¥'", true);
                    }, 1500);
                }

                // å³ä½¿é©—è­‰å¤±æ•—ï¼Œå¦‚æœæ˜¯å…¬é–‹è³‡æ–™åº«ï¼Œä»å¯å˜—è©¦é€£ç·š
                isFirebaseReady = true; 
                setupRealtimeListener();
            }
        }

        initApp();

        // å°‡å¿…è¦åŠŸèƒ½æ›è¼‰åˆ° window ç‰©ä»¶
        window.db = db;
        window.auth = auth;
        window.isFirebaseReady = () => isFirebaseReady;
        
        // è¨­å®šè³‡æ–™åº«é›†åˆè·¯å¾‘
        window.getOrdersCollection = () => {
            return collection(db, 'orders');
        };
        
        // æ›è¼‰ Firestore å‡½å¼
        window.collection = collection;
        window.addDoc = addDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.orderBy = orderBy;
        window.getDocs = getDocs;
        window.writeBatch = writeBatch;
        window.where = where;
    </script>

    <style>
        body {
            background-color: #fefce8; /* æ·¡é»ƒè‰²èƒŒæ™¯ */
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .menu-card {
            transition: all 0.2s;
        }
        .menu-card:active {
            transform: scale(0.98);
        }
        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* è‡ªè¨‚ Toast å‹•ç•« */
        .toast-enter {
            transform: translateY(100%);
            opacity: 0;
        }
        .toast-enter-active {
            transform: translateY(0);
            opacity: 1;
            transition: all 0.3s ease-out;
        }
        .toast-exit {
            transform: translateY(0);
            opacity: 1;
        }
        .toast-exit-active {
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease-in;
        }
        /* Checkbox/Radio Custom Style */
        .custom-checkbox:checked + div {
            background-color: #fef08a; /* yellow-200 */
            border-color: #eab308; /* yellow-500 */
            color: #854d0e; /* yellow-800 */
        }
        .custom-radio:checked + div {
            background-color: #fbbf24; /* amber-400 */
            border-color: #d97706; /* amber-600 */
            color: white;
            font-weight: bold;
        }
        /* AI Chat Bubble Animation */
        .chat-bubble {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Typing indicator */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        /* Tweak Prose styles for Chat */
        .prose p {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        .prose > :first-child {
            margin-top: 0;
        }
        .prose > :last-child {
            margin-bottom: 0;
        }
        .prose ul {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            padding-left: 1.2em;
        }
        .prose li {
            margin-top: 0.2em;
            margin-bottom: 0.2em;
        }
    </style>
</head>
<body class="text-gray-800 pb-32">

    <!-- Header -->
    <header class="bg-yellow-400 shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-2 mb-2">
                <div class="flex items-center gap-3">
                    <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                        <span>ğŸ³</span> ç«‹åˆ©é¤åŠ
                    </h1>
                    <span id="displayDate" class="text-sm font-medium bg-white/80 px-2 py-1 rounded shadow-sm"></span>
                </div>
                
                <!-- Time & Cutoff Display -->
                <div class="bg-gray-800 text-white px-4 py-2 rounded-lg shadow-sm flex items-center justify-between md:justify-end gap-4 min-w-[240px]">
                    <div class="text-xs text-gray-300 flex flex-col items-end border-r border-gray-600 pr-4 mr-1">
                        <div class="mb-1">æˆªæ­¢æ™‚é–“</div>
                        <div class="font-bold text-yellow-400 text-3xl leading-none">10:00</div>
                    </div>
                    <div class="text-right">
                        <div id="statusText" class="text-xs font-bold text-green-400 mb-0.5">è¨‚è³¼ä¸­</div>
                        <div id="currentTime" class="text-xl font-mono font-bold leading-none">--:--:--</div>
                    </div>
                </div>
            </div>
            
            <!-- Info & Name Input -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-2">
                <div class="text-sm text-gray-800 space-y-1 bg-white/50 p-2 rounded">
                    <p>ğŸ“ <span class="font-bold">åœ°å€ï¼š</span>ä¸‰é‡å€è‡ªå¼·è·¯äº”æ®µ33è™Ÿä¹‹1</p>
                    <p>ğŸ“ <span class="font-bold">é›»è©±ï¼š</span><a href="tel:0229833055" class="underline">02-2983-3055</a></p>
                </div>
                
                <div class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-yellow-600">
                    <label for="orderName" class="block text-xs font-bold text-gray-500 uppercase mb-1">é»é¤è€…å§“å <span class="text-red-500">*</span></label>
                    <input type="text" id="orderName" placeholder="è«‹è¼¸å…¥æ‚¨çš„å¤§å" class="w-full border-b-2 border-yellow-300 focus:border-yellow-500 outline-none py-1 text-lg transition-colors bg-transparent">
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Layout -->
    <div class="container mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left Column: Menu -->
        <main class="lg:col-span-2">
            
            <!-- Category Tabs -->
            <div class="sticky top-[180px] md:top-[160px] lg:top-[170px] z-30 bg-[#fefce8]/95 backdrop-blur-sm py-2 -mx-4 px-4 mb-2 border-b border-yellow-200">
                 <div class="flex overflow-x-auto gap-2 no-scrollbar" id="categoryTabs">
                    <!-- Categories will be injected here -->
                </div>
            </div>

            <!-- Note Section (Add-on Instructions) -->
            <div class="mb-6 p-4 bg-yellow-100 rounded-lg border border-yellow-300 text-sm shadow-sm">
                <h3 class="font-bold mb-2 flex items-center gap-2 text-yellow-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    åŠ æ–™åƒ¹æ ¼èªªæ˜ (è«‹é»é¸é¤é»é€²è¡Œå‹¾é¸)
                </h3>
                <div class="flex flex-wrap gap-x-6 gap-y-1 text-gray-700">
                    <span>ğŸš åŠ é£¯/éºµ/è‚‰/èœ/é³³æ¢¨ï¼š<span class="font-bold text-red-600">+$10</span></span>
                    <span>ğŸ¥š åŠ è›‹/æ³¡èœï¼š<span class="font-bold text-red-600">+$20</span></span>
                </div>
            </div>

            <!-- Menu Grid -->
            <div id="menuGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4 min-h-[300px]">
                <!-- Menu items will be injected here -->
            </div>

        </main>

        <!-- Right Column: Order History -->
        <aside class="lg:col-span-1 space-y-4">
            <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden sticky top-24">
                <div class="bg-gray-800 text-white p-3">
                    <div class="flex justify-between items-start mb-2">
                        <h2 class="font-bold text-lg flex items-center gap-2 mt-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            å·²é€å‡ºè¨‚å–®
                            <span id="historyCount" class="bg-gray-600 px-2 py-0.5 rounded text-xs ml-1">0</span>
                        </h2>
                        <div class="flex flex-col gap-2 items-end">
                            <!-- Clear All Button -->
                            <button onclick="confirmClearHistory()" class="text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1.5 rounded transition-colors font-bold shadow border border-red-400">
                                çµæŸä»Šå¤©è¨‚è³¼
                            </button>
                            <!-- Copy All Button -->
                            <button onclick="copyAllOrders()" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded transition-colors font-bold shadow border border-blue-400 flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                                </svg>
                                è¤‡è£½å…¨éƒ¨è¨‚å–®
                            </button>
                        </div>
                    </div>
                    <!-- Total Sum Display -->
                    <div class="text-yellow-400 text-sm font-medium flex justify-between items-center border-t border-gray-600 pt-2">
                        <span>ä»Šæ—¥ç´¯è¨ˆç¸½é‡‘é¡ï¼š</span>
                        <span class="text-xl font-bold text-white">$<span id="historyTotalSum">0</span></span>
                    </div>
                </div>
                
                <div id="orderHistoryList" class="p-4 space-y-4 max-h-[60vh] overflow-y-auto bg-gray-50">
                    <p class="text-gray-400 text-center py-4 text-sm">æ­£åœ¨é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«...</p>
                </div>
            </div>
        </aside>

    </div>
    
    <!-- Author Declaration -->
    <div class="w-full text-center py-6 mb-4">
        <p class="inline-block bg-gray-800 text-yellow-400 px-6 py-2 rounded-full font-bold shadow-lg text-sm transform hover:scale-105 transition-transform cursor-default border-2 border-yellow-500">
            â˜… ç³»çµ±è£½ä½œ By Arthur WU â˜…
        </p>
    </div>

    <!-- AI Floating Button -->
    <button onclick="toggleAIChat()" class="fixed bottom-40 right-4 z-50 bg-gradient-to-r from-purple-500 to-indigo-600 text-white p-4 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all border-2 border-white flex items-center justify-center gap-2 group">
        <span class="text-xl group-hover:animate-spin">âœ¨</span>
        <span class="font-bold hidden sm:inline">AI é»é¤åŠ©æ‰‹</span>
    </button>

    <!-- AI Chat Modal -->
    <div id="aiChatModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[80] flex justify-center items-center backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full sm:w-[500px] h-[80vh] sm:rounded-2xl flex flex-col shadow-2xl overflow-hidden relative">
            
            <!-- AI Header -->
            <div class="bg-gradient-to-r from-purple-600 to-indigo-700 p-4 text-white flex justify-between items-center shadow-md">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg">AI æ™ºæ…§æœå‹™ç”Ÿ</h3>
                        <p class="text-xs text-purple-200">âœ¨ Powered by Gemini</p>
                    </div>
                </div>
                <button onclick="toggleAIChat()" class="text-white/80 hover:text-white hover:bg-white/10 p-2 rounded-full transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Chat Area -->
            <div id="aiChatArea" class="flex-1 overflow-y-auto p-4 bg-gray-50 space-y-4">
                <!-- Welcome Message -->
                <div class="flex items-start gap-2 chat-bubble">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                        AI
                    </div>
                    <div class="bg-white border border-gray-200 text-gray-800 px-4 py-2.5 rounded-2xl rounded-tl-none shadow-sm max-w-[85%] text-sm leading-relaxed prose prose-sm prose-purple">
                        <p>æ‚¨å¥½ï¼æˆ‘æ˜¯ç«‹åˆ©é¤åŠçš„ AI æœå‹™ç”Ÿ ğŸ¤–<br>
                        ä¸ç®¡æ˜¯<b>æ¨è–¦èœè‰²</b>ã€<b>é ç®—æ­é…</b>æˆ–æ˜¯<b>è©¢å•é£Ÿæ</b>ï¼Œæˆ‘éƒ½èƒ½å¹«æ‚¨ï¼<br>
                        è©¦è©¦çœ‹å•æˆ‘ï¼šã€Œæœ‰ä»€éº¼ä¸è¾£çš„æ¨è–¦ï¼Ÿã€æˆ–ã€Œæˆ‘æœ‰ 200 å…ƒæƒ³åƒé£½ã€ã€‚</p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-3 bg-white border-t border-gray-100 flex gap-2 items-end">
                <textarea id="aiInput" rows="1" class="flex-1 bg-gray-100 border-0 rounded-xl px-4 py-3 focus:ring-2 focus:ring-purple-500 focus:bg-white transition-all resize-none max-h-32 outline-none text-sm" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ... (Shift+Enter æ›è¡Œ)"></textarea>
                <button onclick="sendAIMessage()" id="aiSendBtn" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-xl shadow-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Cart Bar -->
    <div class="fixed bottom-0 left-0 w-full bg-white shadow-[0_-4px_15px_-3px_rgba(0,0,0,0.1)] border-t border-gray-200 z-50 pb-safe">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center mb-3">
                <div>
                    <p class="text-xs text-gray-500">ç›®å‰è³¼ç‰©è»Šé‡‘é¡</p>
                    <p class="text-2xl font-bold text-red-600">$<span id="totalPrice">0</span></p>
                </div>
                <button onclick="toggleCartDetail()" class="flex items-center gap-1 text-blue-600 text-sm font-medium hover:bg-blue-50 px-3 py-1 rounded transition-colors">
                    æŸ¥çœ‹ç›®å‰æ˜ç´° (<span id="itemCount">0</span>)
                </button>
            </div>
            <div class="grid grid-cols-3 gap-2">
                <button onclick="confirmClearCart()" class="col-span-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-300 transition-colors">
                    æ¸…ç©º
                </button>
                <button onclick="trySubmitOrder()" class="col-span-2 bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 shadow-md active:bg-green-800 transition-colors flex justify-center items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    é€å‡ºè¨‚å–®
                </button>
            </div>
        </div>
    </div>

    <!-- Product Options Modal -->
    <div id="productModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[70] flex justify-center items-end sm:items-center backdrop-blur-sm transition-opacity" onclick="closeProductModal()">
        <div class="bg-white w-full sm:w-[480px] rounded-t-2xl sm:rounded-2xl p-6 max-h-[90vh] overflow-y-auto shadow-2xl transform transition-transform" onclick="event.stopPropagation()">
            
            <!-- Header -->
            <div class="flex justify-between items-start mb-4 border-b border-gray-100 pb-3">
                <div>
                    <h2 id="modalTitle" class="text-xl font-bold text-gray-900">é¤é»åç¨±</h2>
                    <p class="text-gray-500">$<span id="modalBasePrice">0</span></p>
                </div>
                <button onclick="closeProductModal()" class="text-gray-400 hover:text-gray-600 p-1 bg-gray-100 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Content -->
            <div class="space-y-6">
                
                <!-- Sauce Selection (Dynamic) -->
                <div id="modalSauceSection" class="hidden">
                    <h3 class="font-bold text-gray-800 mb-2">é¸æ“‡é†¬æ–™ <span class="text-red-500 text-xs">*å¿…é¸</span></h3>
                    <div class="grid grid-cols-3 gap-2" id="modalSauces">
                        <!-- Sauces injected via JS -->
                    </div>
                </div>

                <!-- Spiciness Selection -->
                <div>
                    <h3 class="font-bold text-gray-800 mb-2">é¸æ“‡è¾£åº¦ <span class="text-red-500 text-xs">*å¿…é¸</span></h3>
                    <div class="grid grid-cols-4 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="spiciness" value="ä¸è¾£" class="custom-radio peer sr-only" checked>
                            <div class="text-center py-2 rounded-lg border border-gray-200 text-sm transition-all text-gray-600">ä¸è¾£</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="spiciness" value="å°è¾£" class="custom-radio peer sr-only">
                            <div class="text-center py-2 rounded-lg border border-gray-200 text-sm transition-all text-gray-600">å°è¾£</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="spiciness" value="ä¸­è¾£" class="custom-radio peer sr-only">
                            <div class="text-center py-2 rounded-lg border border-gray-200 text-sm transition-all text-gray-600">ä¸­è¾£</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="spiciness" value="å¤§è¾£" class="custom-radio peer sr-only">
                            <div class="text-center py-2 rounded-lg border border-gray-200 text-sm transition-all text-gray-600">å¤§è¾£</div>
                        </label>
                    </div>
                </div>

                <!-- Add-ons Selection -->
                <div>
                    <h3 class="font-bold text-gray-800 mb-2">åŠ æ–™é¸æ“‡ <span class="text-gray-400 text-xs">(å¯è¤‡é¸)</span></h3>
                    <div class="grid grid-cols-2 gap-2" id="modalAddons">
                        <!-- Add-ons injected via JS -->
                    </div>
                </div>

                <!-- Quantity -->
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                    <span class="font-bold">æ•¸é‡</span>
                    <div class="flex items-center bg-white rounded-lg border border-gray-200">
                        <button onclick="adjustModalQty(-1)" class="w-10 h-10 flex items-center justify-center text-gray-600 active:bg-gray-100 text-xl font-bold">-</button>
                        <span id="modalQty" class="w-10 text-center font-bold text-gray-800">1</span>
                        <button onclick="adjustModalQty(1)" class="w-10 h-10 flex items-center justify-center text-yellow-600 active:bg-yellow-50 text-xl font-bold">+</button>
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <div class="mt-6 pt-4 border-t border-gray-100">
                <button onclick="confirmAddToCart()" class="w-full bg-yellow-500 text-white font-bold py-3 rounded-xl hover:bg-yellow-600 shadow-md active:bg-yellow-700 transition-all flex justify-between px-6">
                    <span>åŠ å…¥è³¼ç‰©è»Š</span>
                    <span>$<span id="modalTotalPrice">0</span></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Modal (View Details) -->
    <div id="cartModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[60] flex justify-center items-end sm:items-center backdrop-blur-sm transition-opacity" onclick="toggleCartDetail()">
        <div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 max-h-[80vh] overflow-y-auto shadow-2xl transform transition-transform" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-3 border-gray-100">
                <h2 class="text-xl font-bold text-gray-800">æº–å‚™ä¸­çš„é¤é»</h2>
                <button onclick="toggleCartDetail()" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="cartItemsList" class="space-y-3 mb-6 min-h-[100px]">
                <!-- Cart items here -->
            </div>
            <div class="pt-2">
                 <button onclick="toggleCartDetail()" class="bg-gray-800 text-white px-6 py-3 rounded-xl font-bold w-full hover:bg-gray-900 transition-colors">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl transform transition-all">
            <h3 id="confirmTitle" class="text-lg font-bold text-gray-900 mb-3">ç¢ºèªæ¸…ç©º</h3>
            <p id="confirmMessage" class="text-gray-600 mb-6 text-sm leading-relaxed whitespace-pre-wrap">æ‚¨ç¢ºå®šè¦æ¸…ç©ºç›®å‰é¸æ“‡çš„é¤é»å—ï¼Ÿ</p>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition-colors">å–æ¶ˆ</button>
                <button id="confirmActionBtn" onclick="handleConfirmAction()" class="flex-1 px-4 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 transition-colors shadow-lg shadow-red-200">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[80] w-max max-w-[90vw] pointer-events-none"></div>

    <script>
        // --- Gemini API Setup ---
        const apiKey = ""; 

        async function callGeminiAPI(userMessage) {
            const systemPrompt = `ä½ ç¾åœ¨æ˜¯ã€Œç«‹åˆ©é¤åŠã€çš„ç†±æƒ…æœå‹™ç”Ÿã€‚
ä½ çš„ä»»å‹™æ˜¯å”åŠ©é¡§å®¢é»é¤ã€æ¨è–¦èœè‰²ï¼Œä¸¦è§£ç­”é—œæ–¼èœå–®çš„å•é¡Œã€‚
è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼ˆå°ç£ç”¨èªï¼‰å›ç­”ã€‚èªæ°£è¦ªåˆ‡ã€æœ‰ç¦®è²Œã€ç”Ÿå‹•ã€‚
å¯ä»¥ä½¿ç”¨ Emoji è®“å°è©±æ›´æœ‰è¶£ã€‚

ä»¥ä¸‹æ˜¯æˆ‘å€‘çš„å®Œæ•´èœå–®è³‡æ–™ï¼š
${JSON.stringify(menuData)}

æ’ç‰ˆè¦å‰‡ (éå¸¸é‡è¦)ï¼š
1. è«‹å¤§é‡ä½¿ç”¨ Markdown èªæ³•ä¾†å„ªåŒ–é–±è®€é«”é©—ã€‚
2. æ¨è–¦é¤é»æ™‚ï¼Œè«‹å‹™å¿…ä½¿ç”¨ã€Œæ¢åˆ—å¼ã€(Bullet points)ã€‚
3. é¤é»åç¨±èˆ‡åƒ¹æ ¼è«‹ç”¨ **ç²—é«”** æ¨™ç¤ºã€‚
4. æ®µè½ä¹‹é–“è«‹ä¿ç•™ç©ºè¡Œã€‚
5. ä¸è¦ä¸€å¤§æ®µæ–‡å­—æ“ åœ¨ä¸€èµ·ã€‚

å…¶ä»–è¦å‰‡ï¼š
1. åªèƒ½æ¨è–¦èœå–®ä¸Šæœ‰çš„é¤é»ã€‚
2. è‹¥é¡§å®¢è©¢å•åƒ¹æ ¼ï¼Œè«‹ä¾æ“šèœå–®å›ç­”ã€‚
3. è‹¥é¡§å®¢æœ‰ç‰¹æ®Šé£²é£Ÿéœ€æ±‚ï¼ˆå¦‚ä¸åƒç‰›ã€æƒ³åƒè¾£ï¼‰ï¼Œè«‹ç¯©é¸åˆé©çš„é¤é»ã€‚
4. è‹¥é¡§å®¢è¦æ±‚æ¨è–¦å¥—é¤ï¼Œè«‹è¨ˆç®—ç¸½é‡‘é¡ç¢ºä¿åœ¨é ç®—å…§ï¼ˆè‹¥æœ‰é ç®—é™åˆ¶ï¼‰ã€‚
5. å¦‚æœé¡§å®¢è©¢å•æˆªæ­¢æ™‚é–“ï¼Œè«‹å›ç­”æ¯å¤©æ—©ä¸Š 10:00 æˆªæ­¢ã€‚
`;

            const payload = {
                contents: [
                    {
                        parts: [
                            { text: systemPrompt + "\n\né¡§å®¢ï¼š" + userMessage }
                        ]
                    }
                ]
            };

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // Exponential Backoff Logic
            const maxRetries = 5;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        // --- Data ---
        const menuData = [
            {
                category: "è›‹ç‚’é£¯é¡",
                sauces: ["åŸå‘³", "é»‘èƒ¡æ¤’", "å’–å“©", "æ²™èŒ¶", "èŒ„æ±", "æ³¡èœ"],
                items: [
                    { name: "è›‹ç‚’é£¯", price: 70 },
                    { name: "é’æ¤’è›‹ç‚’é£¯", price: 70 },
                    { name: "ç«è…¿è›‹ç‚’é£¯", price: 80 },
                    { name: "è±¬è‚‰è›‹ç‚’é£¯", price: 80 },
                    { name: "é³³æ¢¨è¦ä»è›‹ç‚’é£¯", price: 80 },
                    { name: "è¦ä»è›‹ç‚’é£¯", price: 80 },
                    { name: "ç‰›è‚‰è›‹ç‚’é£¯", price: 80 },
                    { name: "ç¾Šè‚‰è›‹ç‚’é£¯", price: 80 },
                    { name: "é›è‚‰è›‹ç‚’é£¯", price: 80 },
                    { name: "å»ä»”é­šç‚’é£¯", price: 80 },
                    { name: "åŸ¹æ ¹è›‹ç‚’é£¯", price: 80 },
                    { name: "æ³¡èœè›‹ç‚’é£¯", price: 80 },
                    { name: "è‡˜è‚‰è›‹ç‚’é£¯", price: 80 },
                    { name: "é¦™è…¸è›‹ç‚’é£¯", price: 80 },
                    { name: "ä¸‰é®®è›‹ç‚’é£¯", price: 80 },
                    { name: "é®­é­šè›‹ç‚’é£¯", price: 80 },
                    { name: "å¤å¨å¤·ç‚’é£¯", price: 80 }
                ]
            },
            {
                category: "ç‚’æ²³ç²‰",
                sauces: ["åŸå‘³", "æ²™èŒ¶", "å’–å“©", "èŒ„æ±", "æ³¡èœ"],
                items: [
                    { name: "å¹²ç‚’ç‰›æ²³ç²‰", price: 100 },
                    { name: "å¹²ç‚’ç¾Šæ²³ç²‰", price: 100 },
                    { name: "å¹²ç‚’è±¬æ²³ç²‰", price: 100 },
                    { name: "å¹²ç‚’é›æ²³ç²‰", price: 100 },
                    { name: "æ³¡èœç‚’æ²³ç²‰", price: 100 },
                    { name: "ä¸‰é®®ç‚’æ²³ç²‰", price: 100 },
                    { name: "é¦™è…¸ç‚’æ²³ç²‰", price: 100 },
                    { name: "é®­é­šç‚’æ²³ç²‰", price: 100 },
                    { name: "è‡˜è‚‰ç‚’æ²³ç²‰", price: 100 }
                ]
            },
            {
                category: "ç‚’éºµé¡",
                sauces: ["åŸå‘³"],
                items: [
                    { name: "è±¬è‚‰ç‚’éºµ", price: 80 },
                    { name: "è±¬è‚ç‚’éºµ", price: 80 },
                    { name: "ç‰›è‚‰ç‚’éºµ", price: 80 },
                    { name: "ç¾Šè‚‰ç‚’éºµ", price: 80 },
                    { name: "è¦ä»ç‚’éºµ", price: 80 },
                    { name: "æ³¡èœç‚’éºµ", price: 80 },
                    { name: "ä»€éŒ¦ç‚’éºµ", price: 80 },
                    { name: "é®®è¦ç‚’éºµ", price: 80 }
                ]
            },
            {
                category: "ç‡´é£¯é¡",
                sauces: ["åŸå‘³", "æ²™èŒ¶", "å’–å“©"],
                items: [
                    { name: "è±¬è‚‰ç‡´é£¯", price: 80 },
                    { name: "è±¬è‚ç‡´é£¯", price: 80 },
                    { name: "ç‰›è‚‰ç‡´é£¯", price: 80 },
                    { name: "ç¾Šè‚‰ç‡´é£¯", price: 80 },
                    { name: "é›è‚‰ç‡´é£¯", price: 80 },
                    { name: "ä»€éŒ¦ç‡´é£¯", price: 80 },
                    { name: "é®®è¦ç‡´é£¯", price: 80 }
                ]
            },
            {
                category: "æ¹¯éºµ/æ¹¯é¡",
                sauces: [],
                items: [
                    { name: "è±¬è‚‰æ¹¯éºµ", price: 80 },
                    { name: "è±¬è‚æ¹¯éºµ", price: 80 },
                    { name: "ç¾Šè‚‰æ¹¯éºµ", price: 80 },
                    { name: "æ³¡èœæ¹¯éºµ", price: 80 },
                    { name: "ä»€éŒ¦æ¹¯éºµ", price: 80 },
                    { name: "é®®è¦æ¹¯éºµ", price: 80 },
                    { name: "é’èœè±†è…æ¹¯", price: 40 },
                    { name: "è²¢ä¸¸æ¹¯", price: 40 },
                    { name: "è›‹èŠ±æ¹¯", price: 40 },
                    { name: "è±¬è‚æ¹¯", price: 40 },
                    { name: "è›¤èœŠæ¹¯", price: 40 },
                    { name: "èµ¤è‚‰æ¹¯", price: 40 },
                    { name: "è–‘çµ²ç¾Šè‚‰æ¹¯", price: 40 }
                ]
            },
            {
                category: "å–®é»",
                sauces: [],
                items: [
                    { name: "ç‚’é’èœ", price: 50 },
                    { name: "è”¥èŠ±ç…è›‹", price: 70 },
                    { name: "å»ä»”é­šç…è›‹", price: 80 },
                    { name: "è¦ä»ç…è›‹", price: 80 },
                    { name: "ç‚’ç‰›è‚‰", price: 120 },
                    { name: "ç‚’ç¾Šè‚‰", price: 120 }
                ]
            }
        ];

        // --- Add-ons Configuration ---
        const addOnsList = [
            { name: "åŠ é£¯/éºµ", price: 10 },
            { name: "åŠ è‚‰", price: 10 },
            { name: "åŠ èœ", price: 10 },
            { name: "åŠ é³³æ¢¨", price: 10 },
            { name: "åŠ è›‹", price: 20 },
            { name: "åŠ æ³¡èœ", price: 20 }
        ];

        // --- State ---
        let cart = []; 
        let orderHistory = [];
        let currentCategory = "è›‹ç‚’é£¯é¡";
        let cutoffHour = 10;
        let isPastCutoff = false;
        
        // Temporary state for Modal
        let currentModalItem = null;
        let currentModalCategory = null;
        let currentModalQty = 1;

        // --- Initialization ---
        window.onload = () => {
            updateTime();
            setInterval(updateTime, 1000); // Update time every second

            const today = new Date();
            document.getElementById('displayDate').innerText = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
            
            renderCategories();
            renderMenu(currentCategory);
            renderModalAddons();

            // Set up Firestore Realtime Listener handled by initApp()
            
            // AI Input Keydown
            document.getElementById('aiInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendAIMessage();
                }
            });
        };

        // --- Firestore Logic ---
        function setupRealtimeListener() {
            if (!window.db) return;
            
            const q = window.query(window.getOrdersCollection(), window.orderBy("timestamp", "desc"));
            
            window.onSnapshot(q, (querySnapshot) => {
                orderHistory = [];
                querySnapshot.forEach((doc) => {
                    orderHistory.push({ id: doc.id, ...doc.data() });
                });
                renderHistory();
            }, (error) => {
                console.error("Snapshot error:", error);
                if (error.code === 'permission-denied') {
                    document.getElementById('orderHistoryList').innerHTML = 
                        '<p class="text-red-500 text-center py-4 text-sm px-2">æ¬Šé™ä¸è¶³ï¼šè«‹ç¢ºèª Firebase è¦å‰‡æˆ–å•Ÿç”¨åŒ¿åç™»å…¥ã€‚<br>ç›®å‰ç„¡æ³•è®€å–æ­·å²è¨‚å–®ã€‚</p>';
                } else {
                    showToast("åŒæ­¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤", true);
                }
            });
        }

        // --- AI Chat Logic (Keep Existing) ---
        function toggleAIChat() {
            const modal = document.getElementById('aiChatModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                const chatArea = document.getElementById('aiChatArea');
                chatArea.scrollTop = chatArea.scrollHeight;
                setTimeout(() => document.getElementById('aiInput').focus(), 100);
            } else {
                modal.classList.add('hidden');
            }
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const btn = document.getElementById('aiSendBtn');
            const message = input.value.trim();
            const chatArea = document.getElementById('aiChatArea');

            if (!message) return;

            renderChatMessage('user', message);
            input.value = '';
            input.style.height = 'auto'; 
            btn.disabled = true;

            const loadingId = 'loading-' + Date.now();
            const loadingHTML = `
                <div id="${loadingId}" class="flex items-start gap-2 chat-bubble">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                        AI
                    </div>
                    <div class="bg-white border border-gray-200 px-4 py-3 rounded-2xl rounded-tl-none shadow-sm flex items-center gap-1">
                        <div class="w-2 h-2 bg-purple-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-purple-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-purple-400 rounded-full typing-dot"></div>
                    </div>
                </div>
            `;
            chatArea.insertAdjacentHTML('beforeend', loadingHTML);
            chatArea.scrollTop = chatArea.scrollHeight;

            try {
                const aiResponse = await callGeminiAPI(message);
                document.getElementById(loadingId).remove();
                renderChatMessage('ai', aiResponse);
            } catch (error) {
                console.error("AI Error:", error);
                document.getElementById(loadingId).remove();
                renderChatMessage('ai', "æŠ±æ­‰ï¼Œæˆ‘ç›®å‰é€£ç·šæœ‰é»å•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ï¼ğŸ˜…");
            } finally {
                btn.disabled = false;
            }
        }

        function renderChatMessage(role, text) {
            const chatArea = document.getElementById('aiChatArea');
            let html = '';

            if (role === 'user') {
                html = `
                    <div class="flex items-start justify-end gap-2 chat-bubble">
                        <div class="bg-purple-100 text-purple-900 px-4 py-2.5 rounded-2xl rounded-tr-none shadow-sm max-w-[85%] text-sm leading-relaxed whitespace-pre-wrap">${text}</div>
                        <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-xs font-bold flex-shrink-0">
                            æ‚¨
                        </div>
                    </div>
                `;
            } else {
                const rawMarkup = marked.parse(text);
                html = `
                    <div class="flex items-start gap-2 chat-bubble">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                            AI
                        </div>
                        <div class="bg-white border border-gray-200 text-gray-800 px-4 py-2.5 rounded-2xl rounded-tl-none shadow-sm max-w-[85%] text-sm leading-relaxed prose prose-sm prose-purple">
                            ${rawMarkup}
                        </div>
                    </div>
                `;
            }

            chatArea.insertAdjacentHTML('beforeend', html);
            chatArea.scrollTop = chatArea.scrollHeight;
        }


        // --- Time Logic ---
        function updateTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            
            const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('currentTime').innerText = timeString;

            const statusText = document.getElementById('statusText');
            const timeContainer = document.getElementById('currentTime');

            if (hours >= cutoffHour) {
                isPastCutoff = true;
                statusText.innerText = "å·²æˆªæ­¢";
                statusText.className = "text-xs font-bold text-red-400 mb-0.5";
                timeContainer.classList.add('text-red-400');
            } else {
                isPastCutoff = false;
                statusText.innerText = "è¨‚è³¼ä¸­";
                statusText.className = "text-xs font-bold text-green-400 mb-0.5";
                timeContainer.classList.remove('text-red-400');
            }
        }

        // --- Toast System ---
        function showToast(message, isError = false) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            toast.className = `
                mb-3 px-6 py-3 rounded-full shadow-lg font-bold text-sm text-center transform transition-all duration-300
                ${isError ? 'bg-red-500 text-white' : 'bg-gray-800 text-white'}
                toast-enter
            `;
            toast.innerText = message;
            
            container.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-enter-active');
            });

            setTimeout(() => {
                toast.classList.remove('toast-enter-active');
                toast.classList.add('toast-exit-active');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 2500);
        }

        // --- Render Functions ---
        function renderCategories() {
            const container = document.getElementById('categoryTabs');
            container.innerHTML = menuData.map(cat => `
                <button onclick="switchCategory('${cat.category}')" 
                    class="whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold transition-all transform active:scale-95 duration-200
                    ${cat.category === currentCategory 
                        ? 'bg-yellow-500 text-white shadow-md ring-2 ring-yellow-200' 
                        : 'bg-white text-gray-600 border border-gray-200 hover:bg-yellow-50'}">
                    ${cat.category}
                </button>
            `).join('');
        }

        function switchCategory(catName) {
            currentCategory = catName;
            renderCategories();
            renderMenu(catName);
        }

        function renderMenu(catName) {
            const container = document.getElementById('menuGrid');
            const categoryData = menuData.find(c => c.category === catName);
            
            if (!categoryData) return;

            container.innerHTML = categoryData.items.map(item => {
                const totalInCart = cart
                    .filter(c => c.name === item.name)
                    .reduce((sum, c) => sum + c.count, 0);

                return `
                <div class="menu-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center relative overflow-hidden group hover:border-yellow-300 transition-colors cursor-pointer" onclick="openProductModal('${item.name}', ${item.price}, '${catName}')">
                    <div class="flex-1">
                        <h4 class="font-bold text-lg text-gray-800 leading-tight mb-1">${item.name}</h4>
                        <p class="text-gray-500 font-medium">$${item.price}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        ${totalInCart > 0 ? `<span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded-full border border-yellow-200">${totalInCart} ä»½</span>` : ''}
                        <button class="bg-yellow-500 text-white px-4 py-1.5 rounded-lg text-sm font-bold shadow hover:bg-yellow-600 active:scale-95 transition-all">
                            é¸è³¼
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        function renderModalAddons() {
            const container = document.getElementById('modalAddons');
            container.innerHTML = addOnsList.map((addon, index) => `
                <label class="cursor-pointer relative">
                    <input type="checkbox" value="${index}" class="custom-checkbox peer sr-only" onchange="calculateModalTotal()">
                    <div class="border border-gray-200 rounded-lg p-2 text-center transition-all peer-checked:bg-yellow-100 peer-checked:border-yellow-500">
                        <div class="font-bold text-sm text-gray-700">${addon.name}</div>
                        <div class="text-xs text-red-500 font-bold">+$${addon.price}</div>
                    </div>
                </label>
            `).join('');
        }

        // --- Modal Logic ---
        function openProductModal(name, price, categoryName) {
            currentModalItem = { name, price };
            currentModalCategory = menuData.find(c => c.category === categoryName);
            currentModalQty = 1;
            
            document.getElementById('modalTitle').innerText = name;
            document.getElementById('modalBasePrice').innerText = price;
            document.getElementById('modalQty').innerText = 1;
            
            const radios = document.getElementsByName('spiciness');
            radios.forEach(r => r.checked = (r.value === 'ä¸è¾£'));

            const sauceSection = document.getElementById('modalSauceSection');
            const sauceContainer = document.getElementById('modalSauces');
            
            if (currentModalCategory && currentModalCategory.sauces && currentModalCategory.sauces.length > 0) {
                sauceSection.classList.remove('hidden');
                sauceContainer.innerHTML = currentModalCategory.sauces.map((sauce, idx) => `
                    <label class="cursor-pointer">
                        <input type="radio" name="modal_sauce" value="${sauce}" class="custom-radio peer sr-only" ${idx === 0 ? 'checked' : ''}>
                        <div class="text-center py-2 rounded-lg border border-gray-200 text-sm transition-all text-gray-600">${sauce}</div>
                    </label>
                `).join('');
            } else {
                sauceSection.classList.add('hidden');
                sauceContainer.innerHTML = ''; 
            }

            const checkboxes = document.querySelectorAll('#modalAddons input[type="checkbox"]');
            checkboxes.forEach(c => c.checked = false);

            calculateModalTotal();
            
            const modal = document.getElementById('productModal');
            modal.classList.remove('hidden');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.add('hidden');
        }

        function adjustModalQty(change) {
            if (currentModalQty + change >= 1) {
                currentModalQty += change;
                document.getElementById('modalQty').innerText = currentModalQty;
                calculateModalTotal();
            }
        }

        function calculateModalTotal() {
            if (!currentModalItem) return;
            
            let total = currentModalItem.price;
            
            const checkboxes = document.querySelectorAll('#modalAddons input[type="checkbox"]:checked');
            checkboxes.forEach(cb => {
                total += addOnsList[parseInt(cb.value)].price;
            });

            document.getElementById('modalTotalPrice').innerText = total * currentModalQty;
        }

        function confirmAddToCart() {
            if (!currentModalItem) return;

            const spiciness = document.querySelector('input[name="spiciness"]:checked').value;

            let sauce = null;
            const sauceInput = document.querySelector('input[name="modal_sauce"]:checked');
            if (sauceInput) {
                sauce = sauceInput.value;
            }

            const selectedAddOns = [];
            let addOnsPrice = 0;
            document.querySelectorAll('#modalAddons input[type="checkbox"]:checked').forEach(cb => {
                const addon = addOnsList[parseInt(cb.value)];
                selectedAddOns.push(addon);
                addOnsPrice += addon.price;
            });

            const unitTotal = currentModalItem.price + addOnsPrice;

            const addonsKey = selectedAddOns.map(a => a.name).sort().join(',');
            const sauceKey = sauce ? sauce : 'NA';
            const cartKey = `${currentModalItem.name}|${sauceKey}|${spiciness}|${addonsKey}`;

            const existingItemIndex = cart.findIndex(item => item.cartKey === cartKey);

            if (existingItemIndex > -1) {
                cart[existingItemIndex].count += currentModalQty;
            } else {
                cart.push({
                    cartKey: cartKey,
                    name: currentModalItem.name,
                    basePrice: currentModalItem.price,
                    unitTotal: unitTotal,
                    sauce: sauce,
                    spiciness: spiciness,
                    addons: selectedAddOns,
                    count: currentModalQty
                });
            }

            closeProductModal();
            updateUI();
            showToast('å·²åŠ å…¥è³¼ç‰©è»Š');
        }

        function renderCartList() {
            const container = document.getElementById('cartItemsList');
            if (cart.length === 0) {
                container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                    <p>å°šæœªé¸æ“‡ä»»ä½•é¤é»</p>
                </div>`;
                return;
            }
            container.innerHTML = cart.map((item, index) => {
                const addonText = item.addons.length > 0 ? `+ ${item.addons.map(a => a.name).join(', ')}` : '';
                const sauceText = item.sauce ? `<span class="bg-yellow-100 text-yellow-800 px-1 rounded mr-1">${item.sauce}</span>` : '';
                const spicinessText = item.spiciness !== 'ä¸è¾£' ? `<span class="text-red-500 font-bold">${item.spiciness}</span>` : '<span class="text-gray-400">ä¸è¾£</span>';
                
                return `
                <div class="flex justify-between items-start border-b border-dashed border-gray-200 py-3 last:border-0">
                    <div class="flex-1">
                        <div class="font-bold text-gray-800 text-lg">${item.name}</div>
                        <div class="text-sm mt-1 flex flex-wrap gap-y-1 items-center">
                            ${sauceText}
                            ${spicinessText}
                            ${addonText ? `<span class="text-blue-600 ml-1 text-xs border-l pl-1 border-gray-300">${addonText}</span>` : ''}
                        </div>
                        <div class="text-xs text-gray-400 mt-1">å–®åƒ¹ $${item.unitTotal} x ${item.count}</div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="font-bold text-gray-800 text-lg">$${item.unitTotal * item.count}</span>
                        <button onclick="removeCartItem(${index})" class="text-red-400 hover:text-red-600 text-sm px-2 py-1 rounded bg-red-50 hover:bg-red-100 transition-colors">
                            åˆªé™¤
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        function removeCartItem(index) {
            cart.splice(index, 1);
            updateUI();
        }

        function updateUI() {
            const total = cart.reduce((sum, item) => sum + (item.unitTotal * item.count), 0);
            document.getElementById('totalPrice').innerText = total;
            
            const count = cart.reduce((sum, item) => sum + item.count, 0);
            document.getElementById('itemCount').innerText = count;

            renderMenu(currentCategory); 
            renderCartList();
        }

        function toggleCartDetail() {
            const modal = document.getElementById('cartModal');
            modal.classList.toggle('hidden');
        }

        let confirmCallback = null;

        function confirmClearCart() {
            if (cart.length === 0) {
                showToast('ç›®å‰æ²’æœ‰é¸æ“‡ä»»ä½•é¤é»', true);
                return;
            }
            showConfirmDialog('ç¢ºèªæ¸…ç©º', 'æ‚¨ç¢ºå®šè¦æ¸…ç©ºç›®å‰é¸æ“‡çš„é¤é»å—ï¼Ÿ', executeClearCart);
        }

        function confirmClearHistory() {
             if (orderHistory.length === 0) {
                showToast('ç›®å‰æ²’æœ‰æ­·å²è¨‚å–®', true);
                return;
            }
            showConfirmDialog('çµæŸä»Šå¤©è¨‚è³¼', 'ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å·²é€å‡ºçš„æ­·å²è¨‚å–®å—ï¼Ÿ\n(æ­¤æ“ä½œç„¡æ³•å¾©åŸ)', executeClearHistory);
        }

        function showConfirmDialog(title, message, action) {
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMessage').innerText = message;
            confirmCallback = action;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            confirmCallback = null;
        }
        
        function handleConfirmAction() {
            if(confirmCallback) confirmCallback();
            closeConfirmModal();
        }

        function executeClearCart() {
            cart = [];
            updateUI();
            document.getElementById('cartModal').classList.add('hidden');
            showToast('å·²æ¸…ç©ºé¸æ“‡');
        }
        
        async function executeClearHistory() {
            if (!window.isFirebaseReady()) return;
            
            const q = window.query(window.getOrdersCollection());
            const snapshot = await window.getDocs(q);
            const batch = window.writeBatch(window.db);
            
            snapshot.forEach((doc) => {
                batch.delete(doc.ref);
            });

            await batch.commit();
            showToast('å·²æ¸…ç©ºæ‰€æœ‰æ­·å²è¨‚å–®');
        }

        async function executeDeleteOrder(id) {
            if (!window.isFirebaseReady()) return;
            await window.deleteDoc(window.doc(window.db, "orders", id));
            showToast('å·²åˆªé™¤è¨‚å–®');
        }

        async function executeRecallOrder(order) {
            cart = JSON.parse(JSON.stringify(order.items));
            document.getElementById('orderName').value = order.name;
            
            if (window.isFirebaseReady()) {
                await window.deleteDoc(window.doc(window.db, "orders", order.id));
            }

            updateUI();
            showToast('âœï¸ è¨‚å–®å·²è¼‰å…¥ï¼Œè«‹ä¿®æ”¹å¾Œå†æ¬¡é€å‡º');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function trySubmitOrder() {
            const nameInput = document.getElementById('orderName');
            const name = nameInput.value.trim();
            
            if (!name) {
                showToast('è«‹å…ˆè¼¸å…¥é»é¤è€…å§“åï¼', true);
                nameInput.focus();
                nameInput.parentElement.classList.add('animate-pulse', 'ring-2', 'ring-red-400');
                setTimeout(() => nameInput.parentElement.classList.remove('animate-pulse', 'ring-2', 'ring-red-400'), 1000);
                return;
            }

            if (cart.length === 0) {
                showToast('è«‹å…ˆé¸æ“‡é¤é»å†é€å‡ºï¼', true);
                return;
            }

            if(isPastCutoff) {
                const warningMsg = 'ç¾åœ¨å·²è¶…é 10:00 æˆªæ­¢æ™‚é–“ï¼Œç¢ºå®šè¦ç¹¼çºŒé€å‡ºè¨‚å–®å—ï¼Ÿ\n\né€å‡ºçš„è¨‚å–®è«‹ç¢ºå¯¦èˆ‡é¤é»ç™¼èµ·äººå‘ŠçŸ¥ã€‚é¿å…æ²’æœ‰è¨‚åˆ°!';
                showConfirmDialog('é€¾æ™‚æé†’', warningMsg, performSubmitOrder);
                return;
            }
            
            performSubmitOrder();
        }

        async function performSubmitOrder() {
            if (!window.isFirebaseReady()) {
                showToast("âš ï¸ è³‡æ–™åº«å°šæœªé€£ç·š", true);
                return;
            }

            const nameInput = document.getElementById('orderName');
            const name = nameInput.value.trim();
            
            const total = cart.reduce((sum, item) => sum + (item.unitTotal * item.count), 0);
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;

            const newOrder = {
                name: name,
                items: JSON.parse(JSON.stringify(cart)),
                total: total,
                time: timeString,
                timestamp: new Date().getTime()
            };

            await window.addDoc(window.getOrdersCollection(), newOrder);
            
            cart = [];
            updateUI();
            showToast('âœ… è¨‚å–®å·²é€å‡ºï¼');
            nameInput.value = '';
        }

        function renderHistory() {
            const container = document.getElementById('orderHistoryList');
            const countBadge = document.getElementById('historyCount');
            const totalSumEl = document.getElementById('historyTotalSum');
            
            countBadge.innerText = orderHistory.length;
            
            const grandTotal = orderHistory.reduce((sum, order) => sum + order.total, 0);
            totalSumEl.innerText = grandTotal;

            if (orderHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8 text-sm">å°šæœªæœ‰é€å‡ºçš„è¨‚å–®</p>';
                return;
            }

            container.innerHTML = orderHistory.map(order => {
                const itemsHtml = order.items.map(i => {
                    const sauceStr = i.sauce ? `[${i.sauce}]` : '';
                    const spicyStr = i.spiciness !== 'ä¸è¾£' ? `(${i.spiciness})` : '';
                    const addonStr = i.addons.length > 0 ? ` +${i.addons.map(a=>a.name).join('+')}` : '';
                    
                    return `<div class="text-xs bg-gray-50 border px-2 py-1 rounded text-gray-700 w-full mb-1 flex justify-between">
                        <span>${i.name} ${sauceStr} ${spicyStr} ${addonStr}</span>
                        <span class="font-bold">x${i.count}</span>
                    </div>`;
                }).join('');
                
                return `
                <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm relative group">
                    <div class="flex justify-between items-start mb-2 border-b pb-2">
                        <div>
                            <span class="font-bold text-gray-800">#${order.timestamp ? order.timestamp.toString().slice(-4) : '----'}</span>
                            <span class="text-xs text-gray-500 ml-1">${order.time}</span>
                            <div class="text-sm font-bold text-yellow-700 mt-0.5">${order.name}</div>
                        </div>
                        <span class="text-red-600 font-bold text-lg">$${order.total}</span>
                    </div>
                    <div class="mb-3">
                        ${itemsHtml}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="recallOrder('${order.id}')" class="flex-1 text-xs bg-yellow-100 hover:bg-yellow-200 text-yellow-800 py-2 rounded font-bold transition-colors border border-yellow-300">
                            ä¿®æ”¹
                        </button>
                         <button onclick="deleteOrder('${order.id}')" class="flex-none w-8 flex items-center justify-center text-xs bg-red-100 hover:bg-red-200 text-red-600 py-2 rounded font-bold transition-colors border border-red-200" title="åˆªé™¤æ­¤ç­†è¨‚å–®">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        function recallOrder(id) {
            const order = orderHistory.find(o => o.id === id);
            if (!order) return;

            if (cart.length > 0) {
                showConfirmDialog(
                    'ç¢ºèªè¼‰å…¥',
                    'ç›®å‰è³¼ç‰©è»Šå…§å·²æœ‰å•†å“ï¼Œç¢ºå®šè¦è¦†è“‹ä¸¦è¼‰å…¥èˆŠè¨‚å–®å—ï¼Ÿ',
                    () => executeRecallOrder(order)
                );
                return;
            }

            executeRecallOrder(order);
        }

        function deleteOrder(id) {
            showConfirmDialog(
                'åˆªé™¤è¨‚å–®', 
                'ç¢ºå®šè¦åˆªé™¤é€™ç­†æ­·å²è¨‚å–®å—ï¼Ÿ', 
                () => executeDeleteOrder(id)
            );
        }

        function copyAllOrders() {
            if (orderHistory.length === 0) {
                showToast('æ²’æœ‰è¨‚å–®å¯ä»¥è¤‡è£½', true);
                return;
            }

            const date = document.getElementById('displayDate').innerText;
            let allOrdersText = `ã€${date} ç«‹åˆ©é¤åŠè¨‚å–®åŒ¯ç¸½ã€‘\n`;
            allOrdersText += `========================\n`;

            let grandTotal = 0;

            orderHistory.forEach((order, index) => {
                allOrdersText += `${order.name} ($${order.total})\n`;
                order.items.forEach(item => {
                    const sauceStr = item.sauce ? `[${item.sauce}]` : '';
                    const spicyStr = item.spiciness !== 'ä¸è¾£' ? `(${item.spiciness})` : '';
                    const addonStr = item.addons.length > 0 ? ` +${item.addons.map(a=>a.name).join('+')}` : '';
                    allOrdersText += `  - ${item.name} ${sauceStr}${spicyStr}${addonStr} x${item.count}\n`;
                });
                allOrdersText += `------------------------\n`;
                grandTotal += order.total;
            });

            allOrdersText += `\nç¸½è¨ˆé‡‘é¡ï¼š$${grandTotal}`;

            copyTextToClipboard(allOrdersText);
        }

        function copyTextToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showToast('ğŸ“‹ è¨‚å–®æ–‡å­—å·²è¤‡è£½ï¼');
            } catch (err) {
                console.error('è¤‡è£½å¤±æ•—:', err);
                showToast('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½', true);
            } finally {
                document.body.removeChild(textarea);
            }
        }

    </script>
</body>
</html>