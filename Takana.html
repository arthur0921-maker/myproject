<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜ç”°é£Ÿå ‚é»é¤ç³»çµ±</title>
    <!-- å¼•å…¥ Font Awesome ç”¨æ–¼åœ–ç¤º -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #A93628; /* æ—¥å¼ç´… */
            --secondary-color: #F4E9D6; /* ç±³è‰²èƒŒæ™¯ */
            --accent-color: #2C3E50;
            --promo-color: #E67E22; /* å„ªæƒ æ©˜ */
            --text-color: #333;
            --border-radius: 8px;
            --edit-color: #3498db; /* ç·¨è¼¯è— */
            --ai-color: #6c5ce7; /* AI ç´«è‰² */
        }

        body {
            font-family: "Microsoft JhengHei", "PingFang TC", sans-serif;
            background-color: var(--secondary-color);
            margin: 0;
            padding: 20px;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header Area */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border-top: 5px solid var(--primary-color);
            flex-wrap: wrap;
            gap: 10px;
        }

        .header-info h1 { margin: 0; font-size: 1.8rem; color: var(--primary-color); }
        .header-info .sub-info { font-size: 0.95rem; color: #666; margin-top: 8px; line-height: 1.6; }
        
        /* Store Phone Style */
        .store-phone {
            font-weight: bold;
            color: var(--primary-color);
            margin-left: 5px;
            background: #fff5f5;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #ffcccc;
        }

        .clock-area { text-align: right; display: flex; flex-direction: column; align-items: flex-end;}
        .time-display { font-size: 1.5rem; font-weight: bold; font-family: monospace; color: var(--accent-color); transition: color 0.3s; }
        .deadline-msg { font-size: 0.9rem; color: #e74c3c; font-weight: bold; transition: all 0.3s; margin-top: 5px;}
        
        /* Time Over Style */
        .time-over .time-display { color: #c0392b; text-shadow: 0 0 5px rgba(192, 57, 43, 0.2); }
        .time-over .deadline-msg { font-size: 1.3rem; color: #c0392b; animation: pulse 2s infinite; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Connection Status */
        .status-indicator {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 12px;
            background: #eee;
            color: #666;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
            vertical-align: middle;
        }
        .status-indicator.connected { background: #d4edda; color: #155724; }
        .status-indicator.disconnected { background: #f8d7da; color: #721c24; }

        /* Main Layout */
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 1:1 ç­‰å¯¬ */
            gap: 20px;
            flex: 1;
        }

        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; }
            header { flex-direction: column; align-items: flex-start; }
            .clock-area { text-align: left; align-items: flex-start; margin-top: 10px; }
        }

        /* Left Column */
        .menu-section {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px dashed #ddd;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        /* Categories - Modified for 2 Rows */
        .category-tabs-row {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding-bottom: 5px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .category-tabs-row::-webkit-scrollbar { display: none; }
        
        /* Row 1 has a bit more margin */
        #categoryTabs1 { margin-bottom: 8px; }
        #categoryTabs2 { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }

        .cat-btn {
            background: #eee;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            transition: 0.3s;
            font-weight: bold;
            color: #555;
            font-size: 0.9rem;
        }
        .cat-btn:hover { background: #ddd; }
        .cat-btn.active { background: var(--primary-color); color: white; transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .cat-btn.promo-btn {
            background: linear-gradient(135deg, #f1c40f, #e67e22);
            color: white;
            border: 1px solid #d35400;
        }
        .cat-btn.promo-btn.active {
            background: linear-gradient(135deg, #e67e22, #d35400);
            transform: scale(1.1);
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 5px;
        }

        .menu-item {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: #fff;
            position: relative;
            overflow: hidden;
        }
        .menu-item:hover { 
            border-color: var(--primary-color); 
            background: #fff5f5; 
            transform: translateY(-3px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .menu-item:active { transform: scale(0.98); }
        
        .item-name { font-size: 0.9rem; font-weight: bold; margin-bottom: 8px; line-height: 1.3; }
        .item-price { color: var(--primary-color); font-weight: bold; font-size: 1rem; }

        .current-selection {
            margin-top: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: var(--border-radius);
            border: 1px solid #eee;
        }
        
        .selection-list { 
            margin: 10px 0; 
            max-height: 150px; 
            overflow-y: auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .selection-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            font-size: 0.9rem; 
            padding: 5px 8px; 
            background: white;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .btn-submit {
            width: 100%;
            background: var(--primary-color);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 6px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 15px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .btn-submit:hover { background: #8f2d20; shadow: 0 4px 10px rgba(169, 54, 40, 0.3); }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }
        .btn-submit.is-editing { background: var(--edit-color); }
        .btn-submit.is-editing:hover { background: #2980b9; }

        .btn-cancel-edit {
            width: 100%;
            background: #95a5a6;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 6px;
            margin-top: 10px;
            cursor: pointer;
            display: none;
        }

        /* Right Column: Order List */
        .order-panel {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            height: fit-content;
            max-height: 85vh;
            position: sticky;
            top: 20px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }
        .panel-header span:first-child { font-weight: bold; font-size: 1.1rem; }

        .order-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 5px;
        }

        .order-card {
            background: #fdfdfd;
            border: 1px solid #eee;
            padding: 16px;
            margin-bottom: 10px;
            border-radius: 6px;
            position: relative;
            transition: 0.2s;
        }
        .order-card:hover { border-color: #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .order-card.editing { border: 2px solid var(--edit-color); background: #ebf5fb; }
        
        .order-header { 
            font-weight: bold; 
            color: var(--accent-color); 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 8px; 
            font-size: 1.1rem; 
        }
        .order-items { 
            font-size: 1.05rem; 
            color: #444; 
            margin-top: 5px; 
            line-height: 1.6; 
            white-space: pre-wrap; 
        }
        .order-total { 
            text-align: right; 
            font-weight: bold; 
            color: var(--primary-color); 
            font-size: 1.1rem; 
            margin-top: 8px; 
            border-top: 1px dashed #eee; 
            padding-top: 5px; 
        }
        
        .card-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid #ddd;
            background: white;
            font-size: 16px;
            transition: all 0.2s;
        }
        .btn-delete-single { color: #999; }
        .btn-delete-single:hover { color: white; background: #e74c3c; border-color: #e74c3c; }
        .btn-edit-single { color: var(--edit-color); }
        .btn-edit-single:hover { color: white; background: var(--edit-color); border-color: var(--edit-color); }

        .action-area { display: flex; flex-direction: column; gap: 10px; }

        .btn-clear {
            background: white; color: #e74c3c; padding: 10px; border: 1px solid #e74c3c; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold;
            transition: 0.2s;
        }
        .btn-clear:hover { background: #ffeaea; }

        .btn-copy {
            background: #27ae60; color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold;
            display: flex; justify-content: center; align-items: center; gap: 5px;
        }
        .btn-copy:hover { background: #219150; }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 20px;
            color: #888;
            font-weight: bold;
            font-size: 0.9rem;
            padding: 15px;
            background: rgba(255,255,255,0.5);
            border-radius: var(--border-radius);
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-size: 0.95rem;
        }
        #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* --- è‡ªè¨‚ Modal (å–ä»£ confirm/alert) --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-box {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 320px;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        
        .modal-msg { font-size: 1.05rem; margin-bottom: 20px; color: #333; font-weight: bold; line-height: 1.5; }
        .modal-actions { display: flex; justify-content: center; gap: 10px; }
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
        }
        .modal-btn-no { background: #eee; color: #555; }
        .modal-btn-no:hover { background: #ddd; }
        .modal-btn-yes { background: #e74c3c; color: white; }
        .modal-btn-yes:hover { background: #c0392b; }

        /* --- AI Assistant Styles --- */
        .ai-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 1500;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: float 3s ease-in-out infinite;
        }
        .ai-fab:hover { transform: scale(1.1); }
        .ai-fab::after {
            content: "AIåŠ©æ‰‹";
            position: absolute;
            bottom: -25px;
            font-size: 12px;
            color: #6c5ce7;
            font-weight: bold;
            white-space: nowrap;
        }

        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        .ai-chat-window {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            z-index: 1499;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform-origin: bottom right;
            transform: scale(0);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }
        .ai-chat-window.open { transform: scale(1); opacity: 1; pointer-events: all; }

        .ai-header {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }
        .ai-close { cursor: pointer; font-size: 1.2rem; }

        .ai-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .msg-ai {
            align-self: flex-start;
            background: white;
            border-bottom-left-radius: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }
        .msg-user {
            align-self: flex-end;
            background: #6c5ce7;
            color: white;
            border-bottom-right-radius: 2px;
            box-shadow: 0 2px 5px rgba(108, 92, 231, 0.2);
        }

        .ai-input-area {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        .ai-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        .ai-send {
            background: #6c5ce7;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .ai-send:hover { background: #5649c0; }

        /* Formatting for AI Response */
        .ai-rec-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed #ddd;
            padding: 5px 0;
            margin-bottom: 5px;
        }
        .ai-rec-total {
            margin-top: 10px;
            font-weight: bold;
            color: #d35400;
            text-align: right;
        }
        .highlight-text { color: #6c5ce7; font-weight: bold; }

    </style>
</head>
<body>

<header id="mainHeader">
    <div class="header-info">
        <h1>
            <i class="fas fa-utensils"></i> é«˜ç”°é£Ÿå ‚ é»é¤ç³»çµ± V2.5 
            <span id="connStatus" class="status-indicator disconnected"><i class="fas fa-circle"></i> é€£ç·šä¸­...</span>
        </h1>
        <div class="sub-info">
            æ—¥æœŸ: <span id="currentDate"></span> | åœ°é»: 
            <select id="locationSelect" style="border:1px solid #ddd; padding: 4px; border-radius: 4px; font-size:0.95rem; color:#444; cursor:pointer;">
                <option value="æ°‘æ—åº—" selected>æ–°åŒ—å¸‚è˜†æ´²å€æ°‘æ—è·¯174è™Ÿ (æ°‘æ—åº—)</option>
                <option value="é•·å®‰åº—">æ–°åŒ—å¸‚è˜†æ´²å€é•·å®‰è¡—223è™Ÿ (é•·å®‰åº—)</option>
            </select>
            <span id="storePhone" class="store-phone"></span>
        </div>
    </div>
    <div class="clock-area" id="clockArea">
        <div id="clock" class="time-display">00:00:00</div>
        <div class="deadline-msg" id="deadlineMsg"><i class="far fa-clock"></i> æ¯æ—¥ 10:00 æˆªæ­¢</div>
    </div>
</header>

<div class="container">
    <div class="menu-section">
        <div class="input-group">
            <label style="font-weight: bold; margin-bottom: 5px; color: #555;">è¨‚è³¼äººå§“åï¼š</label>
            <input type="text" id="userName" class="form-control" placeholder="è«‹è¼¸å…¥é»é¤è€…å§“å (å¿…å¡«)">
        </div>

        <!-- ä¿®æ”¹ï¼šåˆ†ç‚ºå…©åˆ—é¡¯ç¤º -->
        <div class="category-tabs-row" id="categoryTabs1"></div>
        <div class="category-tabs-row" id="categoryTabs2"></div>

        <div class="menu-grid" id="menuGrid"></div>

        <div class="current-selection" id="cartPreview">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #ddd; padding-bottom:5px;">
                <strong><i class="fas fa-shopping-basket"></i> ç›®å‰é¸æ“‡</strong>
                <span style="font-size:0.9rem; color:#666;">å…± <span id="cartCount">0</span> é …</span>
            </div>
            
            <div class="selection-list" id="selectionList">
                <div style="color:#999; text-align:center; padding: 20px 0; grid-column: 1 / -1;">å°šæœªé¸æ“‡é¤é»</div>
            </div>
            <div style="text-align: right; font-weight: bold; margin-top:10px; font-size: 1.1rem;">
                å°è¨ˆ: $<span id="cartTotal">0</span>
            </div>
        </div>

        <button class="btn-submit" id="submitBtn" onclick="trySubmitOrder()">
            <i class="fas fa-paper-plane"></i> é€å‡ºè¨‚å–®
        </button>
        <button class="btn-cancel-edit" id="cancelEditBtn" onclick="cancelEditMode()">
            å–æ¶ˆä¿®æ”¹
        </button>
    </div>

    <div class="order-panel">
        <div class="panel-header">
            <span><i class="fas fa-clipboard-list"></i> ä»Šæ—¥è¨‚å–®åˆ—è¡¨</span>
            <span style="font-size:0.9rem; background: var(--secondary-color); padding: 5px 10px; border-radius: 12px; color: var(--primary-color); font-weight: bold;">
                Total: $<span id="globalTotal">0</span>
            </span>
        </div>
        
        <div class="order-list" id="orderListDisplay">
            <div style="text-align:center; color:#ccc; margin-top:50px;">
                <i class="fas fa-inbox" style="font-size:3rem; margin-bottom:10px;"></i><br>
                æ­£åœ¨é€£ç·šåˆ°é›²ç«¯è³‡æ–™åº«...<br>
                <span style="font-size:0.8rem; color:#666;">è‹¥é•·æ™‚é–“ç„¡åæ‡‰ï¼Œè«‹æª¢æŸ¥ Firebase Console çš„åŒ¿åç™»å…¥è¨­å®š</span>
            </div>
        </div>

        <div class="action-area">
            <button class="btn-copy" onclick="copyOrders()"><i class="fas fa-copy"></i> è¤‡è£½è¨‚å–®å…§å®¹</button>
            <button class="btn-clear" onclick="clearAllOrders()"><i class="fas fa-trash-alt"></i> çµæŸä»Šå¤©è¨‚è³¼ (ä¸€éµæ¸…ç©º)</button>
        </div>
    </div>
</div>

<footer>
    è£½ä½œå®£å‘Š By Arthur WU | V2.5 (Dual Row Categories)
</footer>

<!-- AI åŠ©æ‰‹ FAB -->
<div class="ai-fab" onclick="toggleAIChat()">
    <i class="fas fa-robot"></i>
</div>

<!-- AI èŠå¤©è¦–çª— -->
<div class="ai-chat-window" id="aiChatWindow">
    <div class="ai-header">
        <span><i class="fas fa-sparkles"></i> AI é»é¤åŠ©æ‰‹</span>
        <span class="ai-close" onclick="toggleAIChat()">&times;</span>
    </div>
    <div class="ai-messages" id="aiMessages">
        <div class="message msg-ai">
            å—¨ï¼æˆ‘æ˜¯é«˜ç”°é£Ÿå ‚çš„ AI åŠ©æ‰‹ âœ¨<br>
            æˆ‘å¯ä»¥å¹«æ‚¨æ¨è–¦é¤é»å–”ï¼<br>
            ä¾‹å¦‚ï¼šã€Œæˆ‘æœ‰ 200 å…ƒæƒ³åƒé£½ä¸€é»ã€ã€ã€Œæƒ³åƒé­šã€ã€ã€Œæ¨è–¦ä»€éº¼å®šé£Ÿï¼Ÿã€
        </div>
    </div>
    <div class="ai-input-area">
        <input type="text" class="ai-input" id="aiInput" placeholder="è¼¸å…¥æ‚¨çš„éœ€æ±‚..." onkeypress="handleAIKeyPress(event)">
        <button class="ai-send" onclick="sendAIMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<div id="toast">è¨Šæ¯æç¤º</div>

<!-- è‡ªè¨‚ç¢ºèªè¦–çª— -->
<div class="modal-overlay" id="confirmModal">
    <div class="modal-box">
        <div class="modal-msg" id="confirmMessage">ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</div>
        <div class="modal-actions">
            <button class="modal-btn modal-btn-no" onclick="closeConfirm()">å–æ¶ˆ</button>
            <button class="modal-btn modal-btn-yes" onclick="onConfirmYes()">ç¢ºå®š</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase Configuration (User Provided) ---
    const firebaseConfig = {
        apiKey: "AIzaSyANGawGf-vaA_COKkYbFJN0yGcBZmwOxpw",
        authDomain: "takada-4bbc4.firebaseapp.com",
        projectId: "takada-4bbc4",
        storageBucket: "takada-4bbc4.firebasestorage.app",
        messagingSenderId: "956659079766",
        appId: "1:956659079766:web:4404833a013911a67d39f7",
        measurementId: "G-BG5SZKZMC1"
    };

    // --- Firebase Init ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    const collectionName = 'takada_orders';

    // --- UI Status ---
    function setConnectionStatus(isConnected, msg = "") {
        const el = document.getElementById("connStatus");
        if (isConnected) {
            el.className = "status-indicator connected";
            el.innerHTML = '<i class="fas fa-circle"></i> å·²é€£ç·š';
        } else {
            el.className = "status-indicator disconnected";
            el.innerHTML = `<i class="fas fa-times-circle"></i> é€£ç·šå¤±æ•— ${msg}`;
        }
    }

    // --- å…¨åŸŸè®Šæ•¸ ---
    let currentCart = [];
    let allOrders = [];
    let editingOrderId = null; 
    let editingDocId = null;

    // --- å®Œæ•´èœå–®è³‡æ–™ ---
    const menuData = {
        "åŠ è³¼å„ªæƒ ": [
             {name: "â˜…å‡ç´šå®šé£ŸåŠ åƒ¹è³¼", price: 135}, {name: "â˜…é»ƒé‡‘è±¬æ’åŠ åƒ¹è³¼", price: 78},
             {name: "â˜…å”æšé›åŠ åƒ¹è³¼", price: 78}, {name: "â˜…å”æšè±†è…åŠ åƒ¹è³¼", price: 48},
             {name: "â˜…å’–å“©é†¬åŠ åƒ¹è³¼", price: 10}, {name: "â˜…éº’éºŸä¸€ç•ªæ¦¨", price: 110}
        ],
        "æ—¥å¼ä¾¿ç•¶": [
            {name: "ä¹å“å¾¡è†³å¼ç•¶", price: 168}, {name: "ç…§ç‡’é›è…¿ä¾¿ç•¶", price: 138},
            {name: "æ—¥å¼è±¬æ’ä¾¿ç•¶", price: 128}, {name: "å’–å“©è±¬æ’ä¾¿ç•¶", price: 128},
            {name: "æŒªå¨è–„é¹½é¯–é­šä¾¿ç•¶", price: 138}, {name: "ç‰¹è£½ç‡’è‚‰ä¾¿ç•¶", price: 128},
            {name: "åŒ—æµ·é“é®­é­šä¾¿ç•¶", price: 138}, {name: "ç‚¸è¦ä¾¿ç•¶", price: 170},
            {name: "ç‰›å°æ’ä¾¿ç•¶", price: 168}, {name: "æµ¦ç‡’é°»é­šé£¯", price: 250},
            {name: "é†¬ç‡’ä¸­å·ä¾¿ç•¶", price: 158}, {name: "å”æšç‚¸é›ä¾¿ç•¶", price: 148},
            {name: "å‘³å™Œé­šä¾¿ç•¶", price: 138}, {name: "é¹½ç‡’æ—¬é¦™é­šä¾¿ç•¶", price: 148},
            {name: "é¦™é­šç”˜éœ²ç…®ä¾¿ç•¶", price: 163}, {name: "ç«¹ç­´é­šä¾¿ç•¶", price: 180},
            {name: "èµ¤å®—é­šä¾¿ç•¶", price: 138}, {name: "ç¦ªé¢¨ç´ é£Ÿä¾¿ç•¶", price: 120}
        ],
        "å®šé£Ÿ": [
            {name: "æ—¥å¼é»ƒé‡‘è±¬æ’å®šé£Ÿ", price: 238}, {name: "å‚³å¥‡ç…§ç‡’é›è…¿å®šé£Ÿ", price: 258},
            {name: "å’–å“©é¢¨å‘³è±¬æ’å®šé£Ÿ", price: 248}, {name: "æŒªå¨è–„é¹½é¯–é­šå®šé£Ÿ", price: 248},
            {name: "ç«ç‘°é¹½ç‰›å°æ’å®šé£Ÿ", price: 268}, {name: "ç‚¸è¦å¤©å©¦ç¾…å®šé£Ÿ", price: 268},
            {name: "è’²ç‡’é°»é­šå®šé£Ÿ", price: 348}, {name: "åŒ—æµ·é“çƒ¤é®­é­šå®šé£Ÿ", price: 248},
            {name: "é†¬ç‡’ä¸­å·å®šé£Ÿ", price: 248}, {name: "å”æšç‚¸é›å®šé£Ÿ", price: 268},
            {name: "è‡ªå®¶æ¼¬å‘³å™Œé­šå®šé£Ÿ", price: 248}, {name: "é¹½ç‡’é¦™é­šå®šé£Ÿ", price: 248},
            {name: "ç«¹ç­´é­šå®šé£Ÿ", price: 263}, {name: "é¦™é­šç”˜éœ²ç…®å®šé£Ÿ", price: 288},
            {name: "èµ¤å®—é­šå®šé£Ÿ", price: 248}, {name: "ä¸‰å“ç”Ÿé­šç‰‡å®šé£Ÿ", price: 278},
            {name: "é¤Šç”Ÿç¦ªé¢¨å®šé£Ÿ", price: 238}
        ],
        "ç”Ÿä¸¼é£¯": [
            {name: "æ——é­šä¸¼", price: 138}, {name: "ä¸‰å“ç”Ÿé­šç‰‡ä¸¼", price: 165},
            {name: "é®­é­šè¦ªå­ä¸¼", price: 220}, {name: "é®­é­šè‚šä¸¼", price: 235},
            {name: "é®­é­šæµ·æ™¯ä¸¼", price: 250}, {name: "æ•£å£½å¸", price: 210},
            {name: "è”¥èŠ±é®ªé­šä¸¼", price: 240}, {name: "æ˜Ÿé°»æµ·æ™¯ä¸¼", price: 250},
            {name: "å¤©ä½¿ç´…è¦æµ·é®®ä¸¼", price: 280}, {name: "è±ªè¯ç››åˆåˆºèº«ä¸¼", price: 380}
        ],
        "ç”Ÿé­šç‰‡": [
            {name: "åŠ ç‚™ç‡’", price: 20}, {name: "æ——é­šç”Ÿé­šç‰‡", price: 170},
            {name: "é®­é­šç”Ÿé­šç‰‡", price: 210}, {name: "é®­é­šè‚š", price: 230},
            {name: "é®ªé­šç”Ÿé­šç‰‡", price: 240}, {name: "å¤©ä½¿ç´…è¦åˆºèº«(ä¸‰å°¾)", price: 200},
            {name: "ä¸‰å“ç”Ÿé­šç‰‡", price: 230}, {name: "äº”å“ç”Ÿé­šç‰‡", price: 285},
            {name: "è±ªè¯ç››åˆåˆºèº«", price: 395}
        ],
        "æ¡å£½å¸": [
            {name: "åŠ ç‚™ç‡’", price: 20}, {name: "ç¶œåˆå…­è²«æ¡å£½å¸", price: 190},
            {name: "ç¶œåˆä¸‰è²«æ¡å£½å¸", price: 100}, {name: "ç‚™ç‡’é®­é­šæ¡å£½å¸(ä¸‰è²«)", price: 115},
            {name: "é®­é­šæ¡å£½å¸(ä¸‰è²«)", price: 100}, {name: "é®ªé­šæ¡å£½å¸(ä¸‰è²«)", price: 115},
            {name: "èŠ±ææ¡å£½å¸(ä¸‰è²«)", price: 100}, {name: "é®®è¦æ¡å£½å¸(ä¸‰è²«)", price: 95},
            {name: "è›‹æ¢æ¡å£½å¸(ä¸‰è²«)", price: 70}, {name: "èŸ¹è‚‰æ£’æ¡å£½å¸(ä¸‰è²«)", price: 70},
            {name: "ç‚™ç‡’å¹²è²æ¡å£½å¸(ä¸€è²«)", price: 90}, {name: "ç‚™ç‡’å¤©ä½¿ç´…è¦æ¡å£½å¸(äºŒè²«)", price: 85},
            {name: "å¹²è²æ¡å£½å¸(ä¸€è²«)", price: 75}, {name: "æ˜Ÿé°»æ¡å£½å¸(äºŒè²«)", price: 80}
        ],
        "æ‰‹æ²/æ²å£½å¸": [
            {name: "é®®è¦è˜†ç­æ‰‹æ²", price: 60}, {name: "é®®è¦æ‰‹æ²", price: 55},
            {name: "è˜†ç­æ‰‹æ²", price: 50}, {name: "é®­é­šåµæ‰‹æ²", price: 100},
            {name: "è¦åµæ‰‹æ²", price: 60}, {name: "è”¥èŠ±é®ªé­šæ‰‹æ²", price: 75},
            {name: "ç‰ç±³æ²™æ‹‰æ‰‹æ²", price: 50}, {name: "èŸ¹è‚‰æ£’æ‰‹æ²", price: 55},
            {name: "å°é»ƒç“œæ‰‹æ²", price: 50}, {name: "è±†çš®å£½å¸(å…­å€‹)", price: 70},
            {name: "ç¶œåˆè±†çš®å£½å¸(å…­å€‹)", price: 90}, {name: "è±¬æ’æ²™æ‹‰æ²å£½å¸(ä¸€æ¢)", price: 110},
            {name: "æ—¥å¼ç‡’è‚‰æ²å£½å¸(ä¸€æ¢)", price: 110}
        ],
        "ä¸¼é£¯/éºµ/æ³¡é£¯": [
            {name: "é»ƒé‡‘è±¬æ’ä¸¼", price: 120}, {name: "ç…§ç‡’é›è…¿ä¸¼", price: 125},
            {name: "ç¶“å…¸ç‰›ä¸¼", price: 120}, {name: "è¦ªå­ä¸¼", price: 115},
            {name: "è®šå²æµ·é™¸æ¹¯çƒé¾", price: 135}, {name: "äº¬éƒ½è±†çš®è±¬æ’æ¹¯çƒé¾", price: 105},
            {name: "äº¬éƒ½è±†çš®æ¹¯çƒé¾", price: 148}, {name: "é‹ç‡’æ„éºµ", price: 85},
            {name: "æµ·é™¸æ³¡é£¯", price: 90}
        ],
        "èŒ¶ç¢—è’¸/è›‹åŒ…é£¯/æ¹¯": [
            {name: "èŒ¶ç¢—è’¸", price: 50}, {name: "èŒ„æ±è›‹åŒ…é£¯", price: 80},
            {name: "èŒ„æ±è›‹åŒ…é£¯+(ç‚¸ç‰©)", price: 152}, {name: "å’–å“©è›‹åŒ…é£¯", price: 85},
            {name: "å’–å“©è›‹åŒ…é£¯+(ç‚¸ç‰©)", price: 158}, {name: "åœŸç“¶è’¸", price: 60},
            {name: "é¤Šç”Ÿè’œå‘³é›æ¹¯", price: 70}, {name: "å‘³å™Œè›‹åŒ…é­šæ¹¯", price: 35},
            {name: "å‘³å™Œæ¹¯(å°)", price: 10}, {name: "ç´«ç±³ç´…è±†æ¹¯", price: 35}
        ],
        "ç‚’ç‰©": [
            {name: "é®­é­šç‚’é£¯", price: 110}, {name: "å¤å¨å¤·ç‚’é£¯", price: 110},
            {name: "æ«»èŠ±è¦ç‚’é£¯", price: 95}, {name: "è®šå²ç‚’çƒé¾", price: 105},
            {name: "æ¸…ç‚’æ™‚è”¬", price: 100}, {name: "ç‚’æ„éºµ", price: 75},
            {name: "æ«»èŠ±è¦ç‚’æ™‚è”¬", price: 95}, {name: "æº«é‡èœ", price: 95},
            {name: "ç™½é£¯", price: 15}
        ],
        "ç‚¸ç‰©/æ²™æ‹‰": [
            {name: "é…¥ç‚¸é»ƒé‡‘è±¬æ’æ²™æ‹‰", price: 100}, {name: "æ—¥å¼ç‚¸è¦å¤©", price: 150},
            {name: "å”æšç‚¸é›", price: 105}, {name: "å”æšè±†è…", price: 65},
            {name: "é‡èœå”æš", price: 100}, {name: "å–®é»ç‚¸è¦", price: 55},
            {name: "é«˜ç”°ç‰¹è£½æ²™æ‹‰", price: 70}, {name: "é®®è¦æ²™æ‹‰", price: 120},
            {name: "æ´‹èŠ‹æ²™æ‹‰(äºŒçƒ)", price: 45}, {name: "é¾è¦æ²™æ‹‰", price: 50},
            {name: "æ˜å¤ªå­æ²™æ‹‰", price: 50}
        ],
        "ç‡’çƒ¤/ä¸²ç‡’/å°èœ": [
            {name: "é†¬ç‡’ä¸­å·", price: 125}, {name: "è–„é¹½é¯–é­š", price: 110},
            {name: "é†¬ç‡’ç‰›å°æ’", price: 148}, {name: "é¹½ç‡’æ—¬é¦™é­š", price: 110},
            {name: "é¦™é­šç”˜éœ²ç…®", price: 125}, {name: "ç…§ç‡’é»ƒé‡‘é›è…¿", price: 115},
            {name: "åŒ—æµ·é“çƒ¤é®­é­š", price: 100}, {name: "è‡ªå®¶æ¼¬å‘³å™Œé­š", price: 100},
            {name: "è’²ç‡’é°»é­š", price: 270}, {name: "é†¬ç‡’æ¢…èŠ±è‚‰", price: 95},
            {name: "ä¸€å¤œå¹²ç«¹ç­´é­š", price: 150}, {name: "é¹½ç‡’èµ¤å®—é­š", price: 110},
            {name: "å’Œé¢¨ç‰›è‚‰ä¸²", price: 55}, {name: "å­œç„¶ç¾Šè‚‰ä¸²", price: 55},
            {name: "é›ªèŠ±è±¬è‚‰ä¸²", price: 55}, {name: "ç¶œåˆè‚‰ä¸²(è±¬/ç¾Š/ç‰›)", price: 149},
            {name: "å¤©ä½¿ç´…è¦ä¸²", price: 85}, {name: "ç¶ ç¶ èŠ±æ¤°ä¸²", price: 30},
            {name: "é†¬çƒ¤é¦™è‡ä¸²", price: 40}, {name: "é¦™ç”œæ«›ç“œä¸²", price: 30},
            {name: "ç¶œåˆæµ·é®®ä¸²", price: 89}, {name: "ç‰å­ç‡’", price: 75},
            {name: "æ—¥æœ¬æµ·å¸¶èŠ½", price: 45}, {name: "èƒ¡éº»ç¶ èŠ±æ¤°", price: 45},
            {name: "å¹²è²å”‡", price: 55}, {name: "ç”˜å‘³é»‘è±†", price: 55},
            {name: "é®­é­šåµ", price: 165}, {name: "è¦åµ", price: 55}
        ],
        "é£²æ–™": [
            {name: "å†°æ¸…é…’", price: 110}, {name: "æº«æ¸…é…’", price: 110},
            {name: "å¯çˆ¾å¿…æ€", price: 30}, {name: "å¯æ¨‚(ç»ç’ƒç“¶)", price: 25},
            {name: "æŸ³æ©™æ±(ç»ç’ƒç“¶)", price: 25}, {name: "é›ªç¢§(ç»ç’ƒç“¶)", price: 25}
        ]
    };

    // --- åˆå§‹åŒ–: èªè­‰ & ç›£è½ ---
    const initAuth = async () => {
        try {
            await signInAnonymously(auth);
        } catch (error) {
            console.error("Auth Error:", error);
            setConnectionStatus(false, "(Auth Failed)");
            showToast("ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase Console çš„åŒ¿åç™»å…¥è¨­å®š");
        }
    };
    initAuth();

    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("Logged in:", user.uid);
            setupRealtimeListener();
        } else {
            console.log("Logged out");
            setConnectionStatus(false, "(Logged Out)");
        }
    });

    function setupRealtimeListener() {
        const q = collection(db, collectionName);
        
        onSnapshot(q, (snapshot) => {
            setConnectionStatus(true); // æˆåŠŸæ”¶åˆ°è³‡æ–™
            const orders = [];
            snapshot.forEach((doc) => {
                orders.push({ ...doc.data(), docId: doc.id });
            });
            orders.sort((a, b) => b.id - a.id);
            allOrders = orders;
            renderOrderList();
        }, (error) => {
            console.error("Firestore Error:", error);
            setConnectionStatus(false, "(Error)");
            if (error.code === 'permission-denied') {
                showToast("æ¬Šé™éŒ¯èª¤ï¼šè«‹æª¢æŸ¥ Firestore Rules");
            } else {
                showToast("é€£ç·šä¸­æ–·ï¼Œè«‹é‡æ–°æ•´ç†");
            }
        });
    }

    // --- Modal é‚è¼¯ ---
    let confirmCallback = null;

    window.showConfirm = function(msg, callback) {
        document.getElementById('confirmMessage').innerText = msg;
        document.getElementById('confirmModal').style.display = 'flex';
        confirmCallback = callback;
    }

    window.closeConfirm = function() {
        document.getElementById('confirmModal').style.display = 'none';
        confirmCallback = null;
    }

    window.onConfirmYes = function() {
        if (confirmCallback) confirmCallback();
        closeConfirm();
    }

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        updateClock();
        setInterval(updateClock, 1000);
        document.getElementById("currentDate").innerText = new Date().toLocaleDateString();
        renderCategories();
        updateStoreInfo(); // åˆå§‹åŒ–é›»è©±
        
        // è¨­å®šåœ°é»è®Šæ›´äº‹ä»¶
        document.getElementById("locationSelect").addEventListener("change", updateStoreInfo);

        let defaultCat = "æ—¥å¼ä¾¿ç•¶";
        if (!menuData[defaultCat]) defaultCat = Object.keys(menuData)[0];
        
        const btnToClick = Array.from(document.querySelectorAll('.cat-btn')).find(b => b.innerText === defaultCat);
        if(btnToClick) btnToClick.click();
        else renderMenu(Object.keys(menuData)[0]); 
    };

    function updateStoreInfo() {
        const location = document.getElementById("locationSelect").value;
        const phoneEl = document.getElementById("storePhone");
        if (location === "é•·å®‰åº—") {
            phoneEl.innerText = "è¨‚é¤é›»è©±: (02) 2847-6794";
        } else if (location === "æ°‘æ—åº—") {
            phoneEl.innerText = "è¨‚é¤é›»è©±: (02) 8286-3916";
        }
    }

    function updateClock() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const clockEl = document.getElementById("clock");
        const deadlineEl = document.getElementById("deadlineMsg");
        const clockArea = document.getElementById("clockArea");

        clockEl.innerText = `${hours}:${minutes}:${seconds}`;

        if (now.getHours() >= 10) { 
             clockArea.classList.add("time-over");
             deadlineEl.innerHTML = "<i class='fas fa-exclamation-triangle'></i> å·²é 10:00 æˆªæ­¢æ™‚é–“";
        } else {
             clockArea.classList.remove("time-over");
             deadlineEl.innerHTML = "<i class='far fa-clock'></i> æ¯æ—¥ 10:00 æˆªæ­¢";
        }
    }

    // --- æ¸²æŸ“ UI (åˆ†å…©åˆ—) ---
    function renderCategories() {
        const container1 = document.getElementById("categoryTabs1");
        const container2 = document.getElementById("categoryTabs2");
        const categories = Object.keys(menuData);
        
        // åˆ†é¡åˆ‡åˆ†é»: "ä¸¼é£¯/éºµ/æ³¡é£¯"
        const splitIndex = categories.findIndex(c => c === "ä¸¼é£¯/éºµ/æ³¡é£¯");
        
        categories.forEach((cat, index) => {
            const btn = document.createElement("button");
            if (cat === "åŠ è³¼å„ªæƒ ") {
                btn.className = `cat-btn promo-btn`;
                btn.innerHTML = `<i class="fas fa-fire-alt"></i> ${cat}`;
            } else {
                btn.className = `cat-btn`;
                btn.innerText = cat;
            }
            btn.onclick = () => {
                document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderMenu(cat);
            };

            if (index < splitIndex && splitIndex !== -1) {
                container1.appendChild(btn);
            } else {
                container2.appendChild(btn);
            }
        });
    }

    function renderMenu(category) {
        const container = document.getElementById("menuGrid");
        container.innerHTML = "";
        if (!menuData[category]) return;
        menuData[category].forEach(item => {
            const div = document.createElement("div");
            div.className = "menu-item";
            div.innerHTML = `
                <div class="item-name">${item.name}</div>
                <div class="item-price">$${item.price}</div>
            `;
            div.onclick = () => addToCart(item);
            container.appendChild(div);
        });
    }

    // --- è³¼ç‰©è»Š ---
    window.addToCart = function(item) {
        currentCart.push(item);
        updateCartDisplay();
    }

    window.updateCartDisplay = function() {
        document.getElementById("cartCount").innerText = currentCart.length;
        const list = document.getElementById("selectionList");
        list.innerHTML = "";
        if (currentCart.length === 0) {
            list.innerHTML = '<div style="color:#999; text-align:center; padding: 20px 0; grid-column: 1 / -1;">å°šæœªé¸æ“‡é¤é»</div>';
        }
        let total = 0;
        currentCart.forEach((item, index) => {
            total += item.price;
            const div = document.createElement("div");
            div.className = "selection-item";
            div.innerHTML = `
                <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.name}</div>
                <div style="margin-left:5px; font-weight:bold; color:#A93628;">$${item.price}</div>
                <div onclick="removeFromCart(${index})" style="cursor:pointer;color:#ccc; margin-left:8px; padding:0 5px;">
                    <i class="fas fa-times"></i>
                </div>
            `;
            list.appendChild(div);
        });
        document.getElementById("cartTotal").innerText = total;
    }

    window.removeFromCart = function(index) {
        currentCart.splice(index, 1);
        updateCartDisplay();
    }

    // --- è¨‚å–®è™•ç† ---
    window.trySubmitOrder = function() {
        const now = new Date();
        const name = document.getElementById("userName").value.trim();
        
        if (!name) { showToast("è«‹è¼¸å…¥å§“åï¼"); return; }
        if (currentCart.length === 0) { showToast("è«‹è‡³å°‘é¸æ“‡ä¸€æ¨£é¤é»ï¼"); return; }

        if (now.getHours() >= 10) {
            showConfirm("å·²è¶…éè¨‚è³¼æ™‚é–“ï¼Œè«‹èˆ‡è¨‚é¤ç™¼èµ·äººå†æ¬¡ç¢ºèªï¼Œé¿å…æ²’è¨‚åˆ°é¤é»!!!", function() {
                submitOrder();
            });
        } else {
            submitOrder();
        }
    }

    window.submitOrder = async function() {
        const submitBtn = document.getElementById("submitBtn");
        submitBtn.disabled = true;

        const name = document.getElementById("userName").value.trim();
        const location = document.getElementById("locationSelect").value;
        
        const orderDetails = currentCart.map(i => i.name).join(", ");
        const orderPrice = currentCart.reduce((sum, i) => sum + i.price, 0);
        const timestampId = editingOrderId || Date.now();

        const newOrderData = {
            id: timestampId,
            name: name,
            items: orderDetails,
            rawItems: JSON.parse(JSON.stringify(currentCart)), 
            price: orderPrice,
            location: location,
            timestamp: new Date().toLocaleString()
        };

        try {
            if (editingDocId) {
                await updateDoc(doc(db, collectionName, editingDocId), newOrderData);
                showToast("è¨‚å–®ä¿®æ”¹æˆåŠŸï¼");
            } else {
                await addDoc(collection(db, collectionName), newOrderData);
                showToast("è¨‚å–®å·²é€å‡ºï¼");
            }
            cancelEditMode(); 
            currentCart = [];
            updateCartDisplay();
            document.getElementById("userName").value = ""; 
        } catch (e) {
            console.error(e);
            showToast("å‚³é€å¤±æ•—ï¼š" + e.message);
        } finally {
            submitBtn.disabled = false;
        }
    }

    // --- AI åŠ©æ‰‹ ---
    window.toggleAIChat = function() {
        const window = document.getElementById("aiChatWindow");
        window.classList.toggle("open");
        if (window.classList.contains("open")) {
            setTimeout(() => document.getElementById("aiInput").focus(), 300);
        }
    }

    window.handleAIKeyPress = function(e) {
        if (e.key === 'Enter') sendAIMessage();
    }

    window.sendAIMessage = function() {
        const input = document.getElementById("aiInput");
        const msg = input.value.trim();
        if (!msg) return;

        addChatMessage(msg, 'user');
        input.value = "";

        const response = simulateAIResponse(msg);
        setTimeout(() => {
            const aiMsgDiv = addChatMessage("", 'ai');
            typeWriter(aiMsgDiv, response, 0);
        }, 500);
    }

    function addChatMessage(text, type) {
        const container = document.getElementById("aiMessages");
        const div = document.createElement("div");
        div.className = `message msg-${type}`;
        div.innerHTML = text;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        return div;
    }

    function typeWriter(element, html, index) {
        element.innerHTML = html;
        element.style.opacity = 0;
        let op = 0.1;
        let timer = setInterval(function () {
            if (op >= 1){ clearInterval(timer); }
            element.style.opacity = op;
            element.style.filter = 'alpha(opacity=' + op * 100 + ")";
            op += op * 0.1;
        }, 10);
    }

    function simulateAIResponse(query) {
        let response = "";
        let budget = query.match(/\d+/);
        budget = budget ? parseInt(budget[0]) : null;

        const keywords = ["é­š", "è±¬æ’", "é›", "ç‰›", "è¦", "å®šé£Ÿ", "ä¾¿ç•¶", "ä¸¼", "éºµ", "è¾£", "ç‚¸"];
        let allItems = [];
        for (let cat in menuData) {
            menuData[cat].forEach(item => allItems.push({...item, cat: cat}));
        }

        if (budget) {
            let matchedItems = allItems.filter(i => i.price <= budget);
            matchedItems.sort((a,b) => b.price - a.price);
            
            if (matchedItems.length > 0) {
                 response += `æ”¶åˆ°ï¼é ç®— <span class="highlight-text">$${budget}</span> å…ƒï¼Œæˆ‘æœ‰ä»¥ä¸‹æ¨è–¦ï¼š<br><br>`;
                 let top3 = matchedItems.slice(0, 3);
                 top3.forEach(item => {
                     response += `<div class="ai-rec-item"><span>${item.name}</span> <span>$${item.price}</span></div>`;
                 });
                 // Combo logic...
                 for (let i=0; i<matchedItems.length; i++) {
                     let main = matchedItems[i];
                     if (main.price < budget - 30) {
                         let sideBudget = budget - main.price;
                         let sides = allItems.filter(s => s.price <= sideBudget && (s.cat.includes("å°èœ") || s.cat.includes("æ¹¯") || s.cat.includes("ç‚¸ç‰©")));
                         if (sides.length > 0) {
                             let side = sides[Math.floor(Math.random() * sides.length)];
                             response += `<br>âœ¨ <strong>è¶…å€¼çµ„åˆæ¨è–¦ï¼š</strong><br>`;
                             response += `<div class="ai-rec-item"><span>${main.name}</span> <span>$${main.price}</span></div>`;
                             response += `<div class="ai-rec-item"><span>+ ${side.name}</span> <span>$${side.price}</span></div>`;
                             response += `<div class="ai-rec-total">ç¸½è¨ˆ: $${main.price + side.price}</div>`;
                             break;
                         }
                     }
                 }
                 return response;
            } else {
                return "é€™å€‹é ç®—å¯èƒ½æœ‰é»ç·Šç¹ƒ...è¦ä¸è¦å†åŠ ä¸€é»é»ï¼Ÿæœ€ä½çš„ç™½é£¯æ˜¯ 15 å…ƒ ğŸ˜‚";
            }
        } 
        
        let hit = false;
        keywords.forEach(k => {
            if (query.includes(k)) {
                hit = true;
                let filtered = allItems.filter(i => i.name.includes(k));
                if(filtered.length > 0) {
                    response += `æåˆ°ã€Œ<span class="highlight-text">${k}</span>ã€ï¼Œæˆ‘å€‘æœ‰é€™äº›å¥½é¸æ“‡ï¼š<br><br>`;
                    filtered.sort(() => 0.5 - Math.random());
                    filtered.slice(0, 3).forEach(item => {
                        response += `<div class="ai-rec-item"><span>${item.name}</span> <span>$${item.price}</span></div>`;
                    });
                }
            }
        });

        if (hit) return response;

        const randomRecs = [
            "ä¸çŸ¥é“åƒä»€éº¼å—ï¼Ÿ<b>ã€Œæ—¥å¼é»ƒé‡‘è±¬æ’å®šé£Ÿã€</b>æ˜¯æˆ‘å€‘çš„äººæ°£ç‹å–”ï¼",
            "æƒ³åƒé»æ¸…çˆ½çš„å—ï¼Ÿ<b>ã€ŒæŒªå¨è–„é¹½é¯–é­šä¾¿ç•¶ã€</b>éå¸¸å—æ­¡è¿ï¼",
            "ä»Šå¤©çŠ’è³è‡ªå·±ä¸€ä¸‹ï¼Œä¾†ä»½<b>ã€Œè±ªè¯ç››åˆåˆºèº«ä¸¼ã€</b>å¦‚ä½•ï¼Ÿ",
            "å¦‚æœè¶•æ™‚é–“ï¼Œ<b>ã€Œå„ç¨®æ—¥å¼ä¾¿ç•¶ã€</b>ç³»åˆ—éƒ½æ˜¯ç¾åšåˆå¿«é€Ÿçš„é¸æ“‡ï¼"
        ];
        return randomRecs[Math.floor(Math.random() * randomRecs.length)];
    }

    // --- ç·¨è¼¯ ---
    window.editOrder = function(id) {
        const order = allOrders.find(o => o.id === id);
        if (!order) return;
        
        document.getElementById("userName").value = order.name;
        document.getElementById("locationSelect").value = order.location;
        if (order.rawItems && Array.isArray(order.rawItems)) {
            currentCart = JSON.parse(JSON.stringify(order.rawItems));
        } else {
            currentCart = [];
        }
        updateCartDisplay();
        
        editingOrderId = id;        
        editingDocId = order.docId; 
        
        const submitBtn = document.getElementById("submitBtn");
        submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> ç¢ºèªä¿®æ”¹';
        submitBtn.classList.add("is-editing");
        document.getElementById("cancelEditBtn").style.display = "block";
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        renderOrderList();
        showToast("å·²è¼‰å…¥è¨‚å–®ï¼Œè«‹ä¿®æ”¹å¾Œé€å‡º");
    }

    window.cancelEditMode = function() {
        editingOrderId = null;
        editingDocId = null;
        document.getElementById("userName").value = "";
        currentCart = [];
        updateCartDisplay();
        const submitBtn = document.getElementById("submitBtn");
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> é€å‡ºè¨‚å–®';
        submitBtn.classList.remove("is-editing");
        document.getElementById("cancelEditBtn").style.display = "none";
        renderOrderList();
    }

    // --- æ¸²æŸ“åˆ—è¡¨ ---
    window.renderOrderList = function() {
        const container = document.getElementById("orderListDisplay");
        container.innerHTML = "";
        let globalSum = 0;

        if (allOrders.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; color:#ccc; margin-top:50px;">
                    <i class="fas fa-inbox" style="font-size:3rem; margin-bottom:10px;"></i><br>
                    ç›®å‰ç„¡è¨‚å–®
                </div>`;
            document.getElementById("globalTotal").innerText = "0";
            return;
        }

        allOrders.forEach((order) => {
            globalSum += order.price;
            const div = document.createElement("div");
            div.className = `order-card ${editingOrderId === order.id ? 'editing' : ''}`;
            
            div.innerHTML = `
                <div class="card-actions">
                    <button class="btn-icon btn-edit-single" onclick="editOrder(${order.id})" title="ä¿®æ”¹è¨‚å–®">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon btn-delete-single" onclick="deleteOrder(${order.id})" title="åˆªé™¤æ­¤å–®">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="order-header">
                    <span><i class="fas fa-user"></i> ${order.name} <span style="font-size:0.8em; color:#999; font-weight:normal;">(${order.location})</span></span>
                </div>
                <div class="order-items">${order.items}</div>
                <div class="order-total">
                    $${order.price}
                </div>
            `;
            container.appendChild(div);
        });
        document.getElementById("globalTotal").innerText = globalSum;
    }

    // --- åˆªé™¤èˆ‡æ¸…ç©º ---
    window.deleteOrder = function(id) {
        if (editingOrderId === id) cancelEditMode();
        showConfirm("ç¢ºå®šåˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ", async function() {
            const order = allOrders.find(o => o.id === id);
            if (order && order.docId) {
                try {
                    await deleteDoc(doc(db, collectionName, order.docId));
                } catch (e) {
                    showToast("åˆªé™¤å¤±æ•—");
                }
            }
        });
    };

    window.clearAllOrders = function() {
        if (allOrders.length === 0) return;
        showConfirm("ç¢ºå®šè¦ã€ŒçµæŸä»Šå¤©è¨‚è³¼ã€ä¸¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ", async function() {
            try {
                const promises = allOrders.map(o => deleteDoc(doc(db, collectionName, o.docId)));
                await Promise.all(promises);
                editingOrderId = null;
                editingDocId = null;
                cancelEditMode();
                showToast("å·²æ¸…ç©ºæ‰€æœ‰è¨‚å–®");
            } catch (e) {
                showToast("éƒ¨åˆ†è¨‚å–®åˆªé™¤å¤±æ•—");
            }
        });
    }

    window.copyOrders = function() {
        if (allOrders.length === 0) { showToast("ç›®å‰æ²’æœ‰è¨‚å–®"); return; }
        let text = `ã€é«˜ç”°é£Ÿå ‚è¨‚è³¼å–®ã€‘\næ—¥æœŸï¼š${new Date().toLocaleDateString()}\n------------------\n`;
        let total = 0;
        allOrders.forEach(o => {
            text += `${o.name}ï¼š${o.items} ($${o.price})\n`;
            total += o.price;
        });
        text += `------------------\nç¸½é‡‘é¡ï¼š$${total}`;
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => { showToast("è¨‚å–®å…§å®¹å·²è¤‡è£½ï¼"); }).catch(err => { fallbackCopy(text); });
        } else { fallbackCopy(text); }
    }

    window.fallbackCopy = function(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; textArea.style.opacity = "0";
        document.body.appendChild(textArea); textArea.focus(); textArea.select();
        try { document.execCommand('copy'); showToast("è¨‚å–®å…§å®¹å·²è¤‡è£½ï¼"); } catch (err) { showToast("è¤‡è£½å¤±æ•—"); }
        document.body.removeChild(textArea);
    }

    window.showToast = function(msg) {
        const x = document.getElementById("toast");
        x.innerText = msg;
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }
</script>

</body>
</html>