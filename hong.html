<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ˜‡ç‡’è‡˜é»é¤ç³»çµ± V1.5</title>
    <style>
        :root {
            --primary-color: #d35400; /* ç‡’è‡˜è‰² */
            --secondary-color: #f39c12;
            --bg-color: #fdf2e9;
            --text-color: #2c3e50;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 400px 1fr; /* å·¦å´ç¨å¾®åŠ å¯¬ä»¥å®¹ç´æ–¹å¡Š */
            gap: 20px;
        }

        /* Header (Compact Version) */
        header {
            grid-column: 1 / -1;
            background: white;
            padding: 12px 20px; /* ç¸®æ¸›å…§è· */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 5px solid var(--primary-color);
            position: relative;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .title-row {
            display: flex;
            align-items: baseline;
            gap: 12px;
        }

        .title-row h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.8em;
            line-height: 1;
        }

        .version-tag {
            font-size: 0.8em;
            color: #fff;
            background-color: #34495e;
            padding: 2px 6px;
            border-radius: 4px;
            vertical-align: middle;
        }

        .info-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 0.9em;
            color: #555;
            align-items: center;
        }

        .info-row span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .info-row a {
            color: #2980b9;
            text-decoration: none;
        }

        .clock-area {
            text-align: right;
            line-height: 1.2;
            min-width: 110px;
        }

        .clock-label {
            font-size: 0.8em;
            color: #7f8c8d;
        }

        #current-time {
            font-size: 1.4em;
            font-weight: bold;
            font-family: monospace;
            color: var(--text-color);
        }

        .overtime {
            color: red !important;
            font-size: 1.6em !important; /* è¶…æ™‚ç¨å¾®æ”¾å¤§ï¼Œä¸éœ€å¤ªå¤§ */
            transition: all 0.5s ease;
        }

        /* Left Panel: Menu & Input */
        .order-panel {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }

        /* --- æ–¹å¡Šé¸å–®æ¨£å¼ --- */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* æ‰‹æ©Ÿé è¨­3åˆ— */
            gap: 8px;
            margin-bottom: 15px;
        }

        .menu-btn {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 70px;
            user-select: none;
            position: relative; /* For badge */
        }

        .menu-btn:hover {
            border-color: var(--secondary-color);
            background: #fffdf5;
        }

        .menu-btn.active {
            border-color: var(--primary-color);
            background: #fff8f0;
            box-shadow: 0 0 0 1px var(--primary-color);
        }

        .menu-btn .name {
            font-size: 0.95em;
            line-height: 1.2;
            margin-bottom: 4px;
        }

        .menu-btn .price {
            font-size: 0.85em;
            opacity: 0.85;
        }

        .menu-btn .badge {
            display: none;
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.85em;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .menu-btn.active .badge {
            display: flex;
        }

        /* --- è³¼ç‰©è»Šæ¨£å¼ (æ–°) --- */
        .cart-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .cart-title {
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #555;
            display: flex;
            justify-content: space-between;
        }

        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border: 1px solid #eee;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .cart-item-name {
            font-weight: bold;
            flex: 1;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-qty {
            width: 28px;
            height: 28px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-qty:hover { background: #eee; }

        .input-qty-small {
            width: 40px !important;
            text-align: center;
            padding: 4px !important;
            margin: 0 !important;
            height: 28px;
        }

        .btn-remove {
            margin-left: 8px;
            color: #e74c3c;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0 5px;
        }

        .cart-empty-msg {
            text-align: center;
            color: #999;
            font-size: 0.9em;
            padding: 10px;
        }

        .cart-total-bar {
            text-align: right;
            font-weight: bold;
            margin-top: 10px;
            color: var(--primary-color);
        }
        /* ----------------------- */

        button.btn-submit {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            font-size: 1.1em;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }

        button.btn-submit:hover {
            background-color: #a04000;
        }

        /* Right Panel: Order List */
        .list-panel {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .btn-clear-all {
            background-color: #c0392b;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        .order-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .order-card {
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 15px;
            background: #fafafa;
            position: relative;
            transition: transform 0.2s;
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .order-item {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .order-note {
            font-size: 0.9em;
            color: #7f8c8d;
            font-style: italic;
            margin-bottom: 8px;
        }

        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 8px;
        }

        .card-actions button {
            padding: 4px 8px;
            margin-left: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .btn-edit { background: #f39c12; color: white; }
        .btn-delete { background: #e74c3c; color: white; }

        .summary-area {
            margin-top: 30px;
            padding: 15px;
            background: #eaf2f8;
            border-radius: var(--border-radius);
        }

        .btn-copy {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-size: 1.1em;
        }

        .creator-tag {
            text-align: center;
            margin-top: 40px;
            color: #95a5a6;
            font-weight: bold;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 20px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        /* Custom Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
        }

        .modal-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .btn-modal {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        .btn-modal.confirm { background: var(--primary-color); color: white; }
        .btn-modal.cancel { background: #95a5a6; color: white; }

        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
            .menu-grid { grid-template-columns: repeat(3, 1fr); }
            
            header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            .clock-area {
                width: 100%;
                text-align: left;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
        }
        @media (max-width: 400px) {
            .menu-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <div class="title-row">
            <h1>å®æ˜‡ç‡’è‡˜</h1>
            <span class="version-tag">Ver 1.5</span>
        </div>
        <div class="info-row">
            <span>â˜ 02-2288-7343</span>
            <span>ğŸ“ <a href="https://www.google.com/maps/search/?api=1&query=è˜†æ´²å€ä¸­å±±ä¸€è·¯263è™Ÿ" target="_blank">è˜†æ´²å€ä¸­å±±ä¸€è·¯263è™Ÿ</a></span>
            <span>ğŸ“… <span id="date-display"></span></span>
        </div>
    </div>
    <div class="clock-area">
        <div class="clock-label">ç¾åœ¨æ™‚é–“</div>
        <div id="current-time">00:00:00</div>
        <small style="color:#e74c3c; font-weight:bold;">10:00 æˆªæ­¢</small>
    </div>
</header>

<div class="container">
    <!-- å·¦å´ï¼šé»é¤è¡¨å–® -->
    <div class="order-panel">
        <h3>æˆ‘è¦é»é¤</h3>
        <div class="form-group">
            <label for="input-name">å§“å</label>
            <input type="text" id="input-name" placeholder="è«‹è¼¸å…¥å§“å">
        </div>
        
        <!-- æ–¹å¡Šé¸å–® -->
        <div class="form-group">
            <label>é»é¸åŠ å…¥æ¸…å–®</label>
            <div id="menu-grid" class="menu-grid">
                <!-- JS å‹•æ…‹ç”¢ç”Ÿæ–¹å¡Š -->
            </div>
        </div>

        <!-- è³¼ç‰©è»Šå€åŸŸ -->
        <div class="cart-section">
            <div class="cart-title">
                <span>å·²é¸é¤é»</span>
                <span id="cart-count-badge" style="background:#ddd; padding:2px 6px; border-radius:10px; font-size:0.8em;">0</span>
            </div>
            <div id="cart-items-container">
                <div class="cart-empty-msg">å°šæœªé¸æ“‡é¤é»</div>
            </div>
            <div class="cart-total-bar" id="cart-total-display"></div>
        </div>

        <div class="form-group">
            <label for="input-note">å‚™è¨» (å°‡å¥—ç”¨è‡³æ‰€æœ‰é¤é»)</label>
            <textarea id="input-note" rows="2" placeholder="ä¾‹ï¼šé£¯å°‘ã€ä¸è”¥..."></textarea>
        </div>
        <button class="btn-submit" id="btn-submit">é€å‡ºè¨‚å–®</button>
    </div>

    <!-- å³å´ï¼šè¨‚å–®åˆ—è¡¨ -->
    <div class="list-panel">
        <div class="list-header">
            <h3>ä»Šæ—¥è¨‚è³¼æ¸…å–® (ä¾é»é¤é †åº)</h3>
            <button class="btn-clear-all" id="btn-clear-today">æ¸…é™¤ä»Šå¤©è¨‚è³¼è³‡æ–™</button>
        </div>
        <div id="order-container" class="order-grid">
            <p style="color:#999; grid-column:1/-1; text-align:center;">ç›®å‰å°šç„¡è¨‚å–®...</p>
        </div>

        <div class="summary-area">
            <h4>çµ±è¨ˆè³‡è¨Š</h4>
            <div id="total-summary">ç¸½ä»½æ•¸: 0 / ç¸½é‡‘é¡: $0</div>
            <button class="btn-copy" id="btn-copy">è¤‡è£½è¨‚å–®å…§å®¹ (æ–‡å­—ç‰ˆ)</button>
        </div>
    </div>
</div>

<div class="creator-tag">By Arthur WU</div>

<!-- è‡ªå®šç¾© Modal è¦–çª— -->
<div class="modal-overlay" id="custom-modal">
    <div class="modal-box">
        <div class="modal-title" id="modal-title">æç¤º</div>
        <div class="modal-content" id="modal-text">å…§å®¹</div>
        
        <div class="modal-buttons" id="modal-actions-default" style="display:none;">
            <button class="btn-modal cancel" id="modal-btn-cancel">å–æ¶ˆ</button>
            <button class="btn-modal confirm" id="modal-btn-confirm">ç¢ºå®š</button>
        </div>
        
        <div class="modal-buttons" id="modal-actions-alert" style="display:none;">
            <button class="btn-modal confirm" id="modal-btn-ok">çŸ¥é“äº†</button>
        </div>

        <div id="modal-edit-form" style="display:none; text-align:left; margin-top:15px;">
            <div class="form-group">
                <label>ä¿®æ”¹é¤é»</label>
                <select id="edit-select-item">
                    <!-- JS copy options here -->
                </select>
            </div>
            <div class="form-group">
                <label>ä¿®æ”¹æ•¸é‡</label>
                <input type="number" id="edit-input-count" min="1" max="30">
            </div>
            <div class="form-group">
                <label>ä¿®æ”¹å‚™è¨»</label>
                <textarea id="edit-input-note" rows="2"></textarea>
            </div>
            <div class="modal-buttons">
                 <button class="btn-modal cancel" id="modal-edit-cancel">å–æ¶ˆ</button>
                 <button class="btn-modal confirm" id="modal-edit-save">å„²å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBg9gNEVteL-VqHuKnX5g2gdUCeP5HPnos",
    authDomain: "hong-870b0.firebaseapp.com",
    projectId: "hong-870b0",
    storageBucket: "hong-870b0.firebasestorage.app",
    messagingSenderId: "460576156482",
    appId: "1:460576156482:web:543a717b8976e6053cb6db",
    measurementId: "G-Y6WT9GPS94"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const APP_ID = "hongsheng_app";
  const DATA_PATH = `artifacts/${APP_ID}/public/data/orders`;
  
  // State
  let currentOrders = [];
  let isOvertime = false;
  
  // Cart Data Structure: { "itemName|price": count }
  let cartData = {};

  const menuItems = [
    { name: "å’•å’¾è‚‰é£¯", price: 90 },
    { name: "ç‚¸æ’éª¨é£¯", price: 90 },
    { name: "å‰ç‡’é£¯", price: 90 },
    { name: "é¦™è…¸é£¯", price: 90 },
    { name: "æ²¹é›é£¯", price: 90 },
    { name: "çƒ¤é›é£¯", price: 90 },
    { name: "çƒ¤é´¨é£¯", price: 100 },
    { name: "å‰é›é£¯", price: 100 },
    { name: "å‰é´¨é£¯", price: 100 },
    { name: "å‰è…¸é£¯", price: 100 },
    { name: "é›é´¨é£¯", price: 100 },
    { name: "æ²¹é›è…¿é£¯", price: 110 },
    { name: "çƒ¤é›è…¿é£¯", price: 110 },
    { name: "ä¸‰å¯¶é£¯", price: 120 },
    { name: "æ‹›ç‰Œé£¯", price: 130 },
    { name: "é´¨è…¿é£¯", price: 130 },
    { name: "å‰ç‡’æ²¹é›è…¿é£¯", price: 130 },
    { name: "å‰ç‡’çƒ¤é›è…¿é£¯", price: 130 },
    { name: "å‰ç‡’é´¨è…¿é£¯", price: 150 },
    { name: "èœé£¯(å››èœ)", price: 60 }
  ];

  // --- 2. Initialize Menu & Auth ---
  
  function initMenu() {
      const grid = document.getElementById('menu-grid');
      const editSelect = document.getElementById('edit-select-item');

      grid.innerHTML = '';
      editSelect.innerHTML = '';

      menuItems.forEach(item => {
          const valKey = `${item.name}|${item.price}`;

          // Create Grid Buttons
          const btn = document.createElement('div');
          btn.className = 'menu-btn';
          btn.id = `btn-${valKey.replace(/\|/g, '-')}`; // Unique ID for badge updating
          btn.innerHTML = `
            <div class="name">${item.name}</div>
            <div class="price">$${item.price}</div>
            <div class="badge">0</div>
          `;
          
          btn.addEventListener('click', () => {
              addToCart(valKey);
          });

          grid.appendChild(btn);

          // Create Options for Edit Modal
          const opt = document.createElement('option');
          opt.value = valKey;
          opt.textContent = `${item.name} $${item.price}`;
          editSelect.appendChild(opt);
      });
  }
  
  // --- Cart Functions ---

  function addToCart(valKey) {
      if (cartData[valKey]) {
          cartData[valKey]++;
      } else {
          cartData[valKey] = 1;
      }
      if (cartData[valKey] > 30) cartData[valKey] = 30;
      renderCart();
  }

  function updateCartQty(valKey, newQty) {
      let qty = parseInt(newQty);
      if (isNaN(qty) || qty < 1) qty = 1;
      if (qty > 30) qty = 30;
      cartData[valKey] = qty;
      renderCart();
  }

  function removeFromCart(valKey) {
      delete cartData[valKey];
      renderCart();
  }

  function renderCart() {
      const container = document.getElementById('cart-items-container');
      const countBadge = document.getElementById('cart-count-badge');
      const totalDisplay = document.getElementById('cart-total-display');
      
      container.innerHTML = '';
      
      const entries = Object.entries(cartData); // [[key, count], ...]
      
      // Update Menu Badges
      document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
      
      let totalItems = 0;
      let totalCost = 0;

      if (entries.length === 0) {
          container.innerHTML = '<div class="cart-empty-msg">å°šæœªé¸æ“‡é¤é»</div>';
          totalDisplay.textContent = '';
      } else {
          entries.forEach(([key, count]) => {
              const [name, priceStr] = key.split('|');
              const price = parseInt(priceStr);
              totalItems += count;
              totalCost += (price * count);

              // Update Menu Badge
              const btnId = `btn-${key.replace(/\|/g, '-')}`;
              const btnEl = document.getElementById(btnId);
              if (btnEl) {
                  btnEl.classList.add('active');
                  btnEl.querySelector('.badge').textContent = count;
              }

              // Render Cart Item
              const itemDiv = document.createElement('div');
              itemDiv.className = 'cart-item';
              itemDiv.innerHTML = `
                  <div class="cart-item-name">${name}</div>
                  <div class="cart-item-controls">
                      <button class="btn-qty" onclick="window.updateCartStep('${key}', -1)">-</button>
                      <input type="number" class="input-qty-small" value="${count}" onchange="window.updateCartInput('${key}', this.value)">
                      <button class="btn-qty" onclick="window.updateCartStep('${key}', 1)">+</button>
                      <span class="btn-remove" onclick="window.removeCartItem('${key}')">&times;</span>
                  </div>
              `;
              container.appendChild(itemDiv);
          });
          totalDisplay.textContent = `å°è¨ˆ: $${totalCost}`;
      }
      countBadge.textContent = entries.length;
  }

  // Global functions for inline HTML events
  window.updateCartStep = (key, step) => {
      const current = cartData[key] || 0;
      const next = current + step;
      if (next <= 0) {
          removeFromCart(key);
      } else {
          updateCartQty(key, next);
      }
  };
  
  window.updateCartInput = (key, val) => {
      updateCartQty(key, val);
  };
  
  window.removeCartItem = (key) => {
      removeFromCart(key);
  };

  // --- Main Init ---

  initMenu();

  signInAnonymously(auth).then(() => {
      console.log("Signed in anonymously");
      initRealtimeListener();
  }).catch((error) => {
      console.error("Auth Error", error);
      showModal("ç³»çµ±éŒ¯èª¤", "ç„¡æ³•é€£ç·šè‡³è³‡æ–™åº«ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ã€‚");
  });

  // --- 3. UI Logic: Clock & Date ---
  function updateTime() {
      const now = new Date();
      const dateStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;
      document.getElementById('date-display').textContent = dateStr;

      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      const timeStr = `${hours}:${minutes}:${seconds}`;
      
      const timeEl = document.getElementById('current-time');
      timeEl.textContent = timeStr;

      if (now.getHours() >= 10) {
          if (!isOvertime) {
              timeEl.classList.add('overtime');
              isOvertime = true;
          }
      } else {
          timeEl.classList.remove('overtime');
          isOvertime = false;
      }
  }
  setInterval(updateTime, 1000);
  updateTime();

  // --- 4. Helper: Modal System ---
  const modal = document.getElementById('custom-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalText = document.getElementById('modal-text');
  const modalDefaultBtns = document.getElementById('modal-actions-default');
  const modalAlertBtns = document.getElementById('modal-actions-alert');
  const modalEditForm = document.getElementById('modal-edit-form');
  
  function closeModal() {
      modal.style.display = 'none';
  }

  window.showAlert = (title, msg) => {
      modalTitle.textContent = title;
      modalText.textContent = msg;
      modalText.style.display = 'block';
      modalDefaultBtns.style.display = 'none';
      modalEditForm.style.display = 'none';
      modalAlertBtns.style.display = 'flex';
      
      const btnOk = document.getElementById('modal-btn-ok');
      const newBtn = btnOk.cloneNode(true);
      btnOk.parentNode.replaceChild(newBtn, btnOk);
      newBtn.onclick = closeModal;
      modal.style.display = 'flex';
  };

  window.showConfirm = (title, msg, onConfirm) => {
      modalTitle.textContent = title;
      modalText.textContent = msg;
      modalText.style.display = 'block';
      modalAlertBtns.style.display = 'none';
      modalEditForm.style.display = 'none';
      modalDefaultBtns.style.display = 'flex';

      const btnConfirm = document.getElementById('modal-btn-confirm');
      const btnCancel = document.getElementById('modal-btn-cancel');
      
      const newConfirm = btnConfirm.cloneNode(true);
      const newCancel = btnCancel.cloneNode(true);
      btnConfirm.parentNode.replaceChild(newConfirm, btnConfirm);
      btnCancel.parentNode.replaceChild(newCancel, btnCancel);

      newCancel.onclick = closeModal;
      newConfirm.onclick = () => {
          onConfirm();
          closeModal();
      };
      modal.style.display = 'flex';
  };

  window.showEditModal = (orderData, onSave) => {
      modalTitle.textContent = "ä¿®æ”¹è¨‚å–®";
      modalText.style.display = 'none'; 
      modalAlertBtns.style.display = 'none';
      modalDefaultBtns.style.display = 'none';
      modalEditForm.style.display = 'block';

      const editSelect = document.getElementById('edit-select-item');
      const editCount = document.getElementById('edit-input-count');
      
      // Set values
      const valKey = `${orderData.item}|${orderData.price}`;
      editSelect.value = valKey;
      editCount.value = orderData.count || 1; 
      document.getElementById('edit-input-note').value = orderData.note || '';

      const btnSave = document.getElementById('modal-edit-save');
      const btnCancel = document.getElementById('modal-edit-cancel');

      const newSave = btnSave.cloneNode(true);
      const newCancel = btnCancel.cloneNode(true);
      btnSave.parentNode.replaceChild(newSave, btnSave);
      btnCancel.parentNode.replaceChild(newCancel, btnCancel);

      newCancel.onclick = closeModal;
      newSave.onclick = () => {
          const rawVal = editSelect.value.split('|');
          let newCount = parseInt(editCount.value);
          if (newCount < 1) newCount = 1;
          if (newCount > 30) newCount = 30;

          const newData = {
              item: rawVal[0],
              price: parseInt(rawVal[1]),
              count: newCount,
              note: document.getElementById('edit-input-note').value
          };
          onSave(newData);
          closeModal();
      };

      modal.style.display = 'flex';
  }

  // --- 5. Database Operations ---

  function initRealtimeListener() {
      const todayStr = new Date().toISOString().split('T')[0];
      const q = query(collection(db, DATA_PATH));

      onSnapshot(q, (snapshot) => {
          const allDocs = [];
          snapshot.forEach(doc => {
              allDocs.push({ id: doc.id, ...doc.data() });
          });
          
          currentOrders = allDocs
              .filter(order => order.date === todayStr)
              .sort((a, b) => a.timestamp - b.timestamp);

          renderOrders();
      }, (error) => {
         console.error("Snapshot error:", error);
      });
  }

  async function submitOrder() {
      if (isOvertime) {
          showAlert("ç„¡æ³•è¨‚è³¼", "å·²è¶…éè¨‚è³¼æ™‚é–“ï¼Œè«‹èˆ‡è¨‚é¤ç™¼èµ·äººå†æ¬¡ç¢ºèªï¼Œé¿å…æ²’è¨‚åˆ°é¤é»!!!");
          return;
      }

      const nameInput = document.getElementById('input-name');
      const noteInput = document.getElementById('input-note');
      const name = nameInput.value.trim();

      if (!name) {
          showAlert("è³‡æ–™ç¼ºæ¼", "è«‹è¼¸å…¥å§“åï¼");
          return;
      }

      const cartEntries = Object.entries(cartData);
      if (cartEntries.length === 0) {
          showAlert("è³‡æ–™ç¼ºæ¼", "è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œè«‹å…ˆé¸æ“‡é¤é»ï¼");
          return;
      }

      // Loop through cart and create promises
      const promises = cartEntries.map(([key, count]) => {
          const [itemName, itemPrice] = key.split('|');
          const newOrder = {
              name: name,
              item: itemName,
              price: parseInt(itemPrice),
              count: count,
              note: noteInput.value.trim(),
              date: new Date().toISOString().split('T')[0],
              timestamp: Date.now()
          };
          return addDoc(collection(db, DATA_PATH), newOrder);
      });

      try {
          await Promise.all(promises);
          
          // Clear Inputs & Cart
          nameInput.value = '';
          noteInput.value = '';
          cartData = {};
          renderCart();
          
          // Update Menu Badges (reset)
          document.querySelectorAll('.menu-btn').forEach(b => {
             b.classList.remove('active');
             b.querySelector('.badge').textContent = '0';
          });

      } catch (e) {
          console.error(e);
          showAlert("éŒ¯èª¤", "éƒ¨åˆ†æˆ–å…¨éƒ¨è¨‚å–®é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
      }
  }

  async function deleteOrder(id) {
      try {
          await deleteDoc(doc(db, DATA_PATH, id));
      } catch (e) {
          showAlert("éŒ¯èª¤", "åˆªé™¤å¤±æ•—");
      }
  }

  async function updateOrder(id, newData) {
      try {
          await updateDoc(doc(db, DATA_PATH, id), newData);
      } catch (e) {
          showAlert("éŒ¯èª¤", "æ›´æ–°å¤±æ•—");
      }
  }

  async function clearTodayOrders() {
      if (currentOrders.length === 0) return;
      
      const batch = writeBatch(db);
      currentOrders.forEach(order => {
          const ref = doc(db, DATA_PATH, order.id);
          batch.delete(ref);
      });

      try {
          await batch.commit();
          showAlert("å®Œæˆ", "å·²æ¸…ç©ºä»Šæ—¥æ‰€æœ‰è¨‚å–®ã€‚");
      } catch (e) {
          showAlert("éŒ¯èª¤", "æ¸…é™¤å¤±æ•—");
      }
  }

  // --- 6. Rendering ---

  function renderOrders() {
      const container = document.getElementById('order-container');
      const summaryEl = document.getElementById('total-summary');
      
      container.innerHTML = '';
      let totalAmount = 0;
      let totalCount = 0;

      if (currentOrders.length === 0) {
          container.innerHTML = '<p style="color:#999; grid-column:1/-1; text-align:center;">ç›®å‰å°šç„¡è¨‚å–®...</p>';
      } else {
          currentOrders.forEach((order, index) => {
              const count = order.count || 1; 
              const subtotal = order.price * count;
              
              totalAmount += subtotal;
              totalCount += count;

              const card = document.createElement('div');
              card.className = 'order-card';
              card.innerHTML = `
                  <div class="order-header">
                      <span>#${index + 1} ${order.name}</span>
                      <span>$${subtotal}</span>
                  </div>
                  <div class="order-item">${order.item} <span style="font-weight:bold; color:black;">x ${count}</span></div>
                  ${order.note ? `<div class="order-note">å‚™è¨»: ${order.note}</div>` : ''}
                  <div class="order-footer">
                      <small style="color:#ccc">${new Date(order.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
                      <div class="card-actions">
                          <button class="btn-edit" data-id="${order.id}">ä¿®æ”¹</button>
                          <button class="btn-delete" data-id="${order.id}">åˆªé™¤</button>
                      </div>
                  </div>
              `;
              container.appendChild(card);
          });
      }

      summaryEl.textContent = `ç¸½ä»½æ•¸: ${totalCount} / ç¸½é‡‘é¡: $${totalAmount}`;

      document.querySelectorAll('.btn-delete').forEach(btn => {
          btn.addEventListener('click', (e) => {
              const id = e.target.getAttribute('data-id');
              showConfirm("ç¢ºèªåˆªé™¤", "ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ", () => deleteOrder(id));
          });
      });

      document.querySelectorAll('.btn-edit').forEach(btn => {
          btn.addEventListener('click', (e) => {
              const id = e.target.getAttribute('data-id');
              const order = currentOrders.find(o => o.id === id);
              if (order) {
                  showEditModal(order, (newData) => updateOrder(id, newData));
              }
          });
      });
  }

  function copyOrders() {
      if (currentOrders.length === 0) {
          showAlert("æç¤º", "æ²’æœ‰è¨‚å–®å¯ä»¥è¤‡è£½ã€‚");
          return;
      }
      let text = `ã€å®æ˜‡ç‡’è‡˜è¨‚è³¼å–®ã€‘ ${new Date().toLocaleDateString()}\n`;
      let grandTotal = 0;
      
      currentOrders.forEach((o, index) => {
          const count = o.count || 1;
          grandTotal += (o.price * count);
          const noteStr = o.note ? ` (${o.note})` : '';
          text += `${index+1}. ${o.name}ï¼š${o.item} x ${count} $${o.price * count}${noteStr}\n`;
      });
      text += `----------------\nç¸½é‡‘é¡ï¼š$${grandTotal}`;
      
      if (navigator.clipboard && navigator.clipboard.writeText) {
           navigator.clipboard.writeText(text).then(() => {
              showAlert("æˆåŠŸ", "è¨‚å–®å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
          }).catch(err => copyToClipboardFallback(text));
      } else {
          copyToClipboardFallback(text);
      }
  }

  function copyToClipboardFallback(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      try {
          document.execCommand('copy');
          showAlert("æˆåŠŸ", "è¨‚å–®å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
      } catch (err) {
          showAlert("éŒ¯èª¤", "è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚");
      }
      document.body.removeChild(textArea);
  }

  document.getElementById('btn-submit').addEventListener('click', submitOrder);
  document.getElementById('btn-clear-today').addEventListener('click', () => {
      showConfirm("å±éšªæ“ä½œ", "ç¢ºå®šè¦æ¸…ç©ºä»Šå¤©æ‰€æœ‰çš„è¨‚å–®è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚", clearTodayOrders);
  });
  document.getElementById('btn-copy').addEventListener('click', copyOrders);

</script>

</body>
</html>
