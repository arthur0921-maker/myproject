<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¶éµåšåš - ç¢§è¯åœ‹ä¸­æ•™å‹™è™•åˆé¤åœ˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f7f3e8; /* ç±³è‰²èƒŒæ™¯ */
            -webkit-font-smoothing: antialiased;
        }
        .watermark {
            font-size: 0.8rem;
            color: #a89b97;
            text-align: center;
            opacity: 0.6;
            margin-top: 4px;
        }
        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #d4a373; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #bc8a5f; 
        }
        .deadline-passed {
            color: #ef4444;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- è‡ªå®šç¾©å½ˆå‡ºè¦–çª— (Modal) -->
    <div id="customModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden transition-opacity duration-300 opacity-0 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm transform transition-all scale-95 duration-300 border-t-4 border-orange-500">
            <h3 id="modalTitle" class="text-xl font-bold text-gray-800 mb-2 flex items-center gap-2"></h3>
            <p id="modalMessage" class="text-gray-600 mb-6 leading-relaxed"></p>
            <div id="modalActions" class="flex justify-end gap-3">
                <!-- Javascript will inject buttons here -->
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥ä¸­é®ç½© -->
    <div id="loadingOverlay" class="fixed inset-0 z-40 flex items-center justify-center bg-white bg-opacity-80 backdrop-blur-sm">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mb-3"></div>
            <p id="loadingText" class="text-gray-600 font-bold animate-pulse">é€£ç·šåŒæ­¥ä¸­...</p>
        </div>
    </div>

    <header class="bg-white shadow-md z-20 shrink-0 border-t-4 border-orange-500">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3">
                
                <div class="text-center md:text-left flex-1 w-full md:w-auto">
                    <div class="flex flex-wrap items-baseline gap-3 justify-center md:justify-start">
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 tracking-wide flex items-center gap-2">
                            <span>ğŸ¦¢ å¶éµåšåš</span>
                            <span class="text-sm text-gray-400 font-normal self-end mb-1">V3.1 (ç¢§è¯å°ˆç”¨ç‰ˆ)</span>
                            <span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-lg border border-orange-200">ç¢§è¯åœ‹ä¸­åœ˜</span>
                        </h1>
                        <div id="clockDisplay" class="text-lg font-mono font-bold text-gray-600 bg-gray-100 px-2 rounded">00:00:00</div>
                    </div>
                    <div class="flex items-center justify-center md:justify-start gap-2 mt-1">
                        <p class="text-xs text-gray-500">ğŸ“ ç¢§è¯åœ‹ä¸­æ•™å‹™è™•åˆé¤åœ˜</p>
                        <span class="text-gray-300">|</span>
                        <p class="text-xs text-gray-500">ğŸ“… <span id="currentDate"></span> (æ¯æ—¥ 10:00 æˆªæ­¢)</p>
                    </div>
                </div>

                <div class="flex flex-wrap gap-2 w-full md:w-auto justify-center">
                    <button onclick="window.confirmClearAll()" class="bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 font-bold py-2 px-4 rounded-lg shadow-sm transition-all text-sm flex items-center gap-1 active:scale-95 whitespace-nowrap">
                        <span>ğŸ—‘ï¸</span> æ¸…é™¤ä»Šå¤©è¨‚è³¼è³‡æ–™
                    </button>
                    <button onclick="window.copyAllOrders()" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow transition-all text-sm flex items-center gap-1 active:scale-95 whitespace-nowrap">
                        <span>ğŸ“‹</span> è¤‡è£½è¨‚å–®
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- å·¦å´ï¼šèœå–®å€ -->
        <section class="w-full md:w-2/3 flex flex-col border-r border-gray-200 bg-[#fbfbfb] h-full relative">
            
            <!-- è¼¸å…¥åå­—èˆ‡å‚™è¨»å€ -->
            <div class="p-3 bg-white border-b border-orange-100 shrink-0 shadow-sm z-10">
                <div class="flex flex-col sm:flex-row gap-2 items-end max-w-4xl mx-auto md:mx-0">
                    
                    <div class="flex-1 w-full sm:w-auto grid grid-cols-2 sm:grid-cols-5 gap-2">
                        <!-- å§“åè¼¸å…¥ -->
                        <div class="col-span-2 sm:col-span-2">
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">èª°è¦é»é¤ï¼Ÿ</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">ğŸ‘¤</span>
                                <input type="text" id="userName" placeholder="è«‹è¼¸å…¥å§“å / è™•å®¤" class="w-full pl-9 pr-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-orange-400 focus:outline-none transition-all text-sm">
                            </div>
                        </div>

                        <!-- å‚™è¨»è¼¸å…¥ -->
                        <div class="col-span-2 sm:col-span-3">
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">å‚™è¨» (é¸å¡«)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">âœï¸</span>
                                <input type="text" id="userNote" placeholder="ä¾‹ï¼šä¸è¦è”¥ã€é£¯å°‘" class="w-full pl-9 pr-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-orange-400 focus:outline-none transition-all text-sm">
                            </div>
                        </div>
                    </div>

                    <button onclick="window.submitOrder()" class="w-full sm:w-auto bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-lg shadow-md whitespace-nowrap h-[42px] flex items-center justify-center gap-2 transition-transform active:scale-95">
                        <span>é€å‡º</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- åˆ†é¡æ¨™ç±¤ -->
            <div class="flex overflow-x-auto gap-2 p-2 bg-white border-b border-gray-200 shrink-0 no-scrollbar shadow-[0_2px_5px_rgba(0,0,0,0.02)] z-10" id="categoryTabs">
                <!-- Javascript will inject tabs -->
            </div>

            <!-- èœå–®ç¶²æ ¼ -->
            <div id="menuContainer" class="flex-1 overflow-y-auto p-4 bg-[#f7f3e8]">
                <div id="menuGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-3 pb-20">
                    <!-- Javascript will inject menu items -->
                </div>
            </div>
            
            <!-- åº•éƒ¨æµ®å‹•ï¼šç›®å‰é¸æ“‡ -->
            <div id="currentSelectionBar" class="absolute bottom-4 left-4 right-4 md:left-1/2 md:-translate-x-1/2 md:w-auto md:min-w-[300px] bg-gray-800 text-white p-3 rounded-full shadow-2xl flex justify-between items-center z-20 hidden transform transition-all duration-300 hover:scale-105 cursor-pointer" onclick="window.submitOrder()">
                <div class="flex items-center gap-2 px-2">
                    <div class="bg-orange-500 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold" id="currentCount">0</div>
                    <span class="text-sm">æº–å‚™ä¸‹å–®...</span>
                </div>
                <div class="flex items-center gap-2 px-2 border-l border-gray-600 pl-3">
                    <span class="text-xs text-gray-400">å°è¨ˆ</span>
                    <span class="font-bold text-lg text-orange-400">$<span id="currentTotal">0</span></span>
                </div>
            </div>
        </section>

        <!-- å³å´ï¼šè¨‚å–®æ¸…å–®å€ -->
        <section class="w-full md:w-1/3 bg-white flex flex-col h-full border-t md:border-t-0 md:border-l border-gray-200 shadow-xl z-30">
            <div class="p-3 bg-gray-100 font-bold text-gray-700 flex justify-between items-center shrink-0 border-b border-gray-200">
                <span class="flex items-center gap-2">ğŸ“‹ ä»Šæ—¥è¨‚å–®æ¸…å–®</span>
                <span class="text-xs bg-gray-700 text-white px-2 py-1 rounded-full" id="totalOrdersCount">0ç­†</span>
            </div>
            
            <div id="ordersList" class="flex-1 overflow-y-auto p-3 space-y-3 bg-gray-50">
                <div class="text-center text-gray-400 mt-20 flex flex-col items-center">
                    <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center text-3xl mb-3">ğŸ½ï¸</div>
                    <p>ç›®å‰é‚„æ²’æœ‰äººé»é¤</p>
                    <p class="text-xs mt-2">é€£ç·šåŒæ­¥ä¸­...</p>
                </div>
            </div>

            <div class="p-4 bg-white border-t border-gray-200 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <div class="flex justify-between items-center text-xl font-bold">
                    <span class="text-gray-600 text-base">æœ¬æ—¥ç¸½é‡‘é¡</span>
                    <span class="text-red-600 font-mono text-2xl">$<span id="grandTotal">0</span></span>
                </div>
                <div class="text-xs text-right text-gray-400 mt-1 watermark">Designed by Arthur WU</div>
            </div>
        </section>

    </main>

    <script type="module">
        // 1. ä½¿ç”¨æ‚¨æä¾›çš„ Firebase Config å’Œ 12.7.0 ç‰ˆæœ¬ SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // æ‚¨çš„è¨­å®šæª”
        const firebaseConfig = {
            apiKey: "AIzaSyCi4D6TUHM88K6_gbKlU2RW7ECKfSqR2zk",
            authDomain: "myorder-o2.firebaseapp.com",
            projectId: "myorder-o2",
            storageBucket: "myorder-o2.firebasestorage.app",
            messagingSenderId: "1018780108356",
            appId: "1:1018780108356:web:9792d9f2bcbcc0d8209e11",
            measurementId: "G-9Y8QM1TBVW"
        };
        
        // --- é—œéµä¿®æ”¹ï¼šè·¯å¾‘å°æ‡‰ ---
        // æ‚¨çš„è¦å‰‡ï¼šmatch /artifacts/{appId}/public/data/{document=**}
        // æ‰€ä»¥æˆ‘å€‘å¿…é ˆä½¿ç”¨å°æ‡‰çš„è·¯å¾‘çµæ§‹
        const APP_ID_FOR_DB = "myorder-o2"; // ä½¿ç”¨å°ˆæ¡ˆ ID ç•¶ä½œè·¯å¾‘ä¸­çš„ appId
        const DATA_COLLECTION_NAME = "lunch_orders_v2"; // å¯¦éš›çš„é›†åˆåç¨±

        // --- Firebase Init ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;

        // --- è¼”åŠ©å‡½å¼ï¼šå–å¾—æ­£ç¢ºçš„ Collection åƒè€ƒ ---
        function getOrdersCollectionRef() {
            // å°æ‡‰åˆ°: /artifacts/myorder-o2/public/data/lunch_orders_v2
            return collection(db, 'artifacts', APP_ID_FOR_DB, 'public', 'data', DATA_COLLECTION_NAME);
        }

        // --- 0. Custom Modal System ---
        window.showModal = function(title, message, type = 'info', onConfirm = null) {
            const modal = document.getElementById('customModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalActions = document.getElementById('modalActions');

            modalTitle.innerHTML = title;
            modalMessage.innerHTML = message;
            modalActions.innerHTML = ''; 

            if (type === 'confirm') {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = "px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 font-bold transition-colors";
                cancelBtn.textContent = "å–æ¶ˆ";
                cancelBtn.onclick = window.closeModal;

                const confirmBtn = document.createElement('button');
                confirmBtn.className = "px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-bold shadow-md transition-colors";
                confirmBtn.textContent = "ç¢ºå®šåŸ·è¡Œ";
                confirmBtn.onclick = () => {
                    if (onConfirm) onConfirm();
                    window.closeModal();
                };

                modalActions.appendChild(cancelBtn);
                modalActions.appendChild(confirmBtn);
            } else {
                const okBtn = document.createElement('button');
                okBtn.className = "px-5 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 font-bold shadow-md transition-colors w-full sm:w-auto";
                okBtn.textContent = "çŸ¥é“äº†";
                okBtn.onclick = window.closeModal;
                modalActions.appendChild(okBtn);
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        };

        window.closeModal = function() {
            const modal = document.getElementById('customModal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        };

        // --- 1. Data & Global Vars ---
        const menuData = [
            {
                category: "ä¾¿ç•¶ç³»åˆ—",
                icon: "ğŸ±",
                items: [
                    { name: "æ‹›ç‰Œç„¡éª¨éµè‚‰é£¯ä¾¿ç•¶", price: 110, tag: "äººæ°£" },
                    { name: "è”—é¦™ç…™ç‡»éµè‚‰é£¯ä¾¿ç•¶", price: 110 },
                    { name: "é®®å«©é¹¹æ°´éµè‚‰é£¯ä¾¿ç•¶", price: 110 },
                    { name: "éµè‚‰å£½å–œç‡’ä¾¿ç•¶", price: 110 },
                    { name: "ç„¡éª¨è”—é¦™éµè‚‰é£¯ä¾¿ç•¶", price: 120 },
                    { name: "é®®å«©ç„¡éª¨é¹¹æ°´éµè‚‰é£¯ä¾¿ç•¶", price: 120, tag: "æ¨" },
                    { name: "å°å¼æ‰“æ‹‹éµè‚‰ä¾¿ç•¶", price: 130 },
                    { name: "è”¥é†¬éµè…¿ä¾¿ç•¶", price: 150, tag: "é™é‡" }
                ]
            },
            {
                category: "å¶éµè‚‰ç›¤",
                icon: "ğŸ¦¢",
                items: [
                    { name: "æ‹›ç‰Œç³–ç‡»éµè‚‰(1~2äºº)", price: 200 },
                    { name: "æ‹›ç‰Œç³–ç‡»éµè‚‰(3~4äºº)", price: 350 },
                    { name: "æ‹›ç‰Œå«©é¹¹æ°´éµ(1~2äºº)", price: 200 },
                    { name: "æ‹›ç‰Œå«©é¹¹æ°´éµ(3~4äºº)", price: 350 }
                ]
            },
            {
                category: "äººæ°£ä¸»é£Ÿ",
                icon: "ğŸœ",
                items: [
                    { name: "é¦™è”¥éµæ²¹ä¹¾æ‹Œéºµç·š", price: 40 },
                    { name: "å¶éµåšåš(æ‹›ç‰Œé£¯)", price: 65, tag: "æ‹›ç‰Œ" },
                    { name: "ç‰¹ä¸Šéµè‚‰é£¯", price: 65 },
                    { name: "éµè‚‰ä¹¾éºµ", price: 80 },
                    { name: "éµè‚‰æ¹¯éºµ", price: 80 },
                    { name: "é¦™è”¥éµæ²¹é£¯", price: 20 },
                    { name: "å¤æ—©å‘³ç“œä»”éµç‡¥é£¯", price: 35 },
                    { name: "ä¹¾éºµ", price: 40 },
                    { name: "æ¹¯éºµ", price: 40 },
                    { name: "ä¹¾å†¬ç²‰", price: 40 },
                    { name: "æ¹¯å†¬ç²‰", price: 40 },
                    { name: "éµè‚‰ä¹¾å†¬ç²‰", price: 80 },
                    { name: "éµè‚‰æ¹¯å†¬ç²‰", price: 80 },
                    { name: "ç™½é£¯", price: 15 }
                ]
            },
            {
                category: "ç¾å‘³å°èœ",
                icon: "ğŸ¥¦",
                items: [
                    { name: "æ‹›ç‰ŒåŒ–éª¨éµæŒ(5æ”¯)", price: 70 },
                    { name: "ç¶œåˆä¸‹æ°´", price: 100 },
                    { name: "ç±³è¡€ç³•", price: 50 },
                    { name: "é™é‡ç‚¸éµè›‹", price: 50, tag: "ç¨å®¶" },
                    { name: "éµè…³(éš»)", price: 20 },
                    { name: "éµå±è‚¡(å€‹)", price: 10 },
                    { name: "éµç¿…(éš»)", price: 40 },
                    { name: "éµè…±", price: 60 },
                    { name: "éµé ­(1éš»)", price: 60 },
                    { name: "éµé ­(2éš»)", price: 100 },
                    { name: "éµå¿ƒ+è‚", price: 50 },
                    { name: "é…¸èœéµè…¸", price: 80 },
                    { name: "éŸ­èœéµè…¸", price: 80 },
                    { name: "éµè‚‰é¦™è…¸", price: 60 },
                    { name: "æ¡‚ç«¹ç­", price: 50 },
                    { name: "ç‡™é’èœ/æ™‚è”¬", price: 50 },
                    { name: "éº»è¾£é´¨è¡€", price: 50 },
                    { name: "éº»è¾£è±†è…", price: 50 },
                    { name: "ç¶œåˆéº»è¾£", price: 70 },
                    { name: "éµæ²¹é»ƒé‡‘è·åŒ…è›‹", price: 20 }
                ]
            },
            {
                category: "é®®ç¾æ¹¯å“",
                icon: "ğŸ¥£",
                items: [
                    { name: "éµè‚‰æ¹¯", price: 70 },
                    { name: "ä¸‹æ°´æ¹¯", price: 60 },
                    { name: "é…¸èœéµè…¸æ¹¯", price: 60 },
                    { name: "éµä¸¸æ¹¯", price: 50 }
                ]
            }
        ];

        let currentCategory = "ä¾¿ç•¶ç³»åˆ—";
        let tempCart = {}; 
        let submittedOrders = []; 

        // --- 2. Initialization ---
        window.onload = () => {
            updateTime();
            setInterval(updateTime, 1000);
            
            const today = new Date();
            document.getElementById('currentDate').innerText = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
            
            renderCategoryTabs();
            renderMenu();
            
            // é–‹å§‹ç™»å…¥æµç¨‹
            signInAnonymously(auth).catch(e => {
                console.error("Auth Error", e);
                window.showModal("éŒ¯èª¤", "ç„¡æ³•ç™»å…¥ç³»çµ±ï¼Œè«‹æª¢æŸ¥ Firebase Console æ˜¯å¦å·²å•Ÿç”¨ã€ŒåŒ¿åç™»å…¥ (Anonymous Auth)ã€", "error");
            });
        };

        // ç›£è½ç™»å…¥ç‹€æ…‹
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loadingOverlay').classList.add('hidden'); // éš±è—è¼‰å…¥ç•«é¢
                
                // ç™»å…¥æˆåŠŸå¾Œï¼Œç›£è½ Firestore
                const q = getOrdersCollectionRef();
                
                onSnapshot(q, (snapshot) => {
                    // Update global submittedOrders
                    submittedOrders = snapshot.docs.map(d => ({
                        ...d.data(),
                        firestoreId: d.id
                    }));

                    // Sort locally by creation time (id)
                    submittedOrders.sort((a, b) => a.id - b.id);
                    
                    renderSubmittedOrders();
                }, (error) => {
                    console.error("Firestore Error:", error);
                    // å¦‚æœæ¬Šé™è¢«æ‹’çµ•ï¼Œé€šå¸¸æ˜¯è¦å‰‡å•é¡Œ
                    if(error.code === 'permission-denied') {
                         window.showModal("æ¬Šé™éŒ¯èª¤", "ç„¡æ³•è®€å–è³‡æ–™åº« (Permission Denied)ã€‚<br>è«‹ç¢ºèª Firestore Rules è·¯å¾‘æ˜¯å¦ç‚º /artifacts/myorder-o2/public/data/...", "error");
                    } else {
                         window.showModal("é€£ç·šéŒ¯èª¤", "ç„¡æ³•å–å¾—è¨‚å–®è³‡æ–™ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚", "info");
                    }
                });
            }
        });

        // --- 3. UI Functions ---
        window.switchCategory = function(cat) {
            currentCategory = cat;
            renderCategoryTabs();
            renderMenu();
        }

        window.adjustTempCart = function(name, price, change) {
            if (!tempCart[name]) {
                tempCart[name] = { price: price, count: 0 };
            }
            tempCart[name].count += change;
            
            if (tempCart[name].count <= 0) {
                delete tempCart[name];
            }

            updateTempCartUI();
            renderMenu();
        }

        function renderCategoryTabs() {
            const container = document.getElementById('categoryTabs');
            container.innerHTML = menuData.map(cat => `
                <button onclick="window.switchCategory('${cat.category}')" 
                    class="whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold transition-all flex items-center gap-2 ${cat.category === currentCategory 
                    ? 'bg-gray-800 text-white shadow-md transform scale-105' 
                    : 'bg-white text-gray-600 border border-gray-100 hover:bg-gray-50'}">
                    <span>${cat.icon}</span> ${cat.category}
                </button>
            `).join('');
        }

        function renderMenu() {
            const container = document.getElementById('menuGrid');
            const categoryData = menuData.find(c => c.category === currentCategory);
            
            container.innerHTML = categoryData.items.map(item => {
                const count = tempCart[item.name] ? tempCart[item.name].count : 0;
                const activeClass = count > 0 ? "border-orange-400 ring-1 ring-orange-400 shadow-md bg-orange-50" : "border-gray-100 shadow-sm hover:shadow-md bg-white";
                
                let tagHtml = '';
                if(item.tag) {
                    tagHtml = `<span class="absolute top-0 right-0 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-bl-lg rounded-tr-lg font-bold shadow-sm">${item.tag}</span>`;
                }

                return `
                <div class="relative p-4 rounded-xl border flex flex-col justify-between h-full transition-all duration-200 ${activeClass}">
                    ${tagHtml}
                    <div class="mb-3">
                        <h3 class="font-bold text-gray-800 text-lg leading-tight pr-4">${item.name}</h3>
                        <p class="text-orange-600 font-bold mt-1 text-lg">$${item.price}</p>
                    </div>
                    <div class="flex items-center justify-end rounded-lg p-1">
                        <button onclick="window.adjustTempCart('${item.name}', ${item.price}, -1)" 
                            class="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded-md text-gray-600 font-bold hover:bg-red-50 hover:text-red-500 active:scale-95 disabled:opacity-30 disabled:hover:bg-white disabled:hover:text-gray-600 transition-colors" 
                            ${count === 0 ? 'disabled' : ''}>-</button>
                        <span class="w-10 text-center font-bold text-gray-800 text-lg">${count}</span>
                        <button onclick="window.adjustTempCart('${item.name}', ${item.price}, 1)" 
                            class="w-8 h-8 flex items-center justify-center bg-orange-500 border border-orange-500 rounded-md text-white font-bold hover:bg-orange-600 active:scale-95 shadow-sm transition-colors">+</button>
                    </div>
                </div>
            `}).join('');
        }

        function renderSubmittedOrders() {
            const container = document.getElementById('ordersList');
            const countBadge = document.getElementById('totalOrdersCount');
            const grandTotalEl = document.getElementById('grandTotal');

            if (submittedOrders.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 mt-20 flex flex-col items-center animate-pulse">
                        <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center text-3xl mb-3">ğŸ½ï¸</div>
                        <p>ç›®å‰é‚„æ²’æœ‰äººé»é¤</p>
                        <p class="text-xs mt-2">ç¢§è¯åœ‹ä¸­æ•™å‹™è™•åˆé¤åœ˜é–‹è·‘å›‰ï¼</p>
                    </div>`;
                countBadge.innerText = "0ç­†";
                grandTotalEl.innerText = "0";
                return;
            }

            let totalMoney = 0;
            // Display newest first
            const displayOrders = [...submittedOrders].reverse();

            container.innerHTML = displayOrders.map(order => {
                totalMoney += order.total;
                const itemsHtml = order.items.map(i => 
                    `<div class="flex justify-between text-sm text-gray-600 pl-2 border-l-2 border-gray-200">
                        <span>${i.name} <span class="text-gray-400">x${i.count}</span></span>
                        <span class="font-mono">$${i.price * i.count}</span>
                    </div>`
                ).join('');

                const noteHtml = order.note ? 
                    `<div class="mt-2 text-xs bg-yellow-50 text-yellow-800 p-1.5 rounded border border-yellow-200 flex items-start gap-1">
                        <span>âœï¸</span> <span>${order.note}</span>
                     </div>` : '';

                // Safe quote escaping for HTML
                const safeFirestoreId = order.firestoreId;

                return `
                <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm relative group hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-2 border-b border-dashed border-gray-100 pb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center font-bold text-xs border border-orange-200">
                                ${order.name.charAt(0)}
                            </div>
                            <div>
                                <span class="font-bold text-gray-800 block leading-none">${order.name}</span>
                                <span class="text-[10px] text-gray-400 bg-gray-50 px-1 rounded">${order.time}</span>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="window.editOrder('${safeFirestoreId}')" class="text-gray-300 hover:text-blue-500 transition-colors p-1" title="ä¿®æ”¹æ­¤å–®">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button onclick="window.confirmDeleteOrder('${safeFirestoreId}')" class="text-gray-300 hover:text-red-500 transition-colors p-1" title="åˆªé™¤æ­¤å–®">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-1 mb-2">
                        ${itemsHtml}
                    </div>
                    ${noteHtml}
                    <div class="text-right font-bold text-orange-600 text-sm bg-orange-50 p-1 rounded mt-2">
                        ç¸½è¨ˆ: $${order.total}
                    </div>
                </div>
            `}).join('');

            countBadge.innerText = `${submittedOrders.length}ç­†`;
            grandTotalEl.innerText = totalMoney;
        }

        function updateTempCartUI() {
            const bar = document.getElementById('currentSelectionBar');
            let totalCount = 0;
            let totalPrice = 0;

            for (let key in tempCart) {
                totalCount += tempCart[key].count;
                totalPrice += tempCart[key].count * tempCart[key].price;
            }

            if (totalCount > 0) {
                bar.classList.remove('hidden');
                bar.classList.add('flex');
                document.getElementById('currentCount').innerText = totalCount;
                document.getElementById('currentTotal').innerText = totalPrice;
            } else {
                bar.classList.add('hidden');
                bar.classList.remove('flex');
            }
        }

        function updateTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const timeString = `${hours}:${minutes}:${seconds}`;
            
            const clockEl = document.getElementById('clockDisplay');
            clockEl.innerText = timeString;

            if (now.getHours() >= 10) {
                clockEl.classList.add('deadline-passed');
            } else {
                clockEl.classList.remove('deadline-passed');
            }
        }

        // --- 4. Logic Functions (Async for Firestore) ---

        window.submitOrder = async function() {
            const nameInput = document.getElementById('userName');
            const noteInput = document.getElementById('userNote'); 
            const name = nameInput.value.trim();
            const note = noteInput.value.trim();

            if (!name) {
                window.showModal("æç¤º", "è«‹è¼¸å…¥è¨‚è³¼äººå§“åï¼", "info");
                nameInput.focus();
                return;
            }

            if (Object.keys(tempCart).length === 0) {
                window.showModal("æç¤º", "è«‹å…ˆé¸æ“‡é¤é»ï¼", "info");
                return;
            }

            if (!currentUser) {
                window.showModal("éŒ¯èª¤", "å°šæœªé€£ç·šè‡³è³‡æ–™åº«ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", "error");
                return;
            }

            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            
            let orderItems = [];
            let orderTotal = 0;

            for (let key in tempCart) {
                orderItems.push({
                    name: key,
                    price: tempCart[key].price,
                    count: tempCart[key].count
                });
                orderTotal += (tempCart[key].price * tempCart[key].count);
            }

            const newOrder = {
                id: Date.now(), // Use timestamp as order logic ID for sorting
                name: name,
                note: note, 
                items: orderItems,
                total: orderTotal,
                time: timeStr
            };

            // Firestore Add (ä½¿ç”¨ helper function å–å¾—æ­£ç¢ºè·¯å¾‘)
            try {
                await addDoc(getOrdersCollectionRef(), newOrder);
                
                // Reset UI
                tempCart = {};
                // nameInput.value = ''; // Keep name? usually clearing is better for next person
                nameInput.value = '';
                noteInput.value = ''; 
                updateTempCartUI();
                renderMenu(); 
            } catch (e) {
                console.error(e);
                window.showModal("éŒ¯èª¤", "é€å‡ºè¨‚å–®å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è³‡æ–™åº«è¦å‰‡ã€‚", "error");
            }
        }

        window.editOrder = async function(firestoreId) {
            const order = submittedOrders.find(o => o.firestoreId === firestoreId);
            if(!order) return;

            if(Object.keys(tempCart).length > 0) {
                window.showModal("æç¤º", "æ‚¨ç›®å‰æœ‰æ­£åœ¨é¸æ“‡çš„é¤é»ï¼Œè«‹å…ˆæ¸…ç©ºæˆ–é€å‡ºå¾Œå†ä¿®æ”¹èˆŠè¨‚å–®ã€‚", "info");
                return;
            }
            
            // Restore Form
            document.getElementById('userName').value = order.name;
            document.getElementById('userNote').value = order.note || '';
            
            // Restore Cart
            tempCart = {};
            order.items.forEach(item => {
                tempCart[item.name] = { price: item.price, count: item.count };
            });
            
            // Delete from Firestore immediately to simulate "Move to Cart"
            try {
                await deleteDoc(doc(getOrdersCollectionRef(), firestoreId));
                updateTempCartUI();
                renderMenu();
                window.showModal("ä¿®æ”¹è¨‚å–®", `å·²å–å› <b>${order.name}</b> çš„è¨‚å–®ã€‚<br>è«‹ä¿®æ”¹å…§å®¹å¾Œå†æ¬¡é»æ“Šã€Œé€å‡ºã€ã€‚`, "info");
            } catch(e) {
                window.showModal("éŒ¯èª¤", "ç„¡æ³•ä¿®æ”¹è¨‚å–®ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚", "error");
            }
        }

        window.confirmDeleteOrder = function(firestoreId) {
            window.showModal(
                "åˆªé™¤ç¢ºèª", 
                "ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ<br><span class='text-sm text-red-500'>æ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</span>", 
                "confirm", 
                async () => {
                    try {
                        await deleteDoc(doc(getOrdersCollectionRef(), firestoreId));
                    } catch(e) {
                         window.showModal("éŒ¯èª¤", "åˆªé™¤å¤±æ•—ã€‚", "error");
                    }
                }
            );
        }

        window.confirmClearAll = function() {
            window.showModal(
                "è­¦å‘Šï¼šæ¸…é™¤æ‰€æœ‰è³‡æ–™", 
                "æ‚¨ç¢ºå®šè¦ã€Œæ¸…é™¤ä»Šå¤©æ‰€æœ‰è¨‚è³¼è³‡æ–™ã€ä¸¦é‡æ–°é–‹å§‹å—ï¼Ÿ<br><br><span class='text-red-600 font-bold'>âš ï¸ é€™å°‡æœƒåˆªé™¤ç›®å‰æ‰€æœ‰çš„è¨‚å–®ç´€éŒ„ï¼</span>", 
                "confirm", 
                async () => {
                     // Delete all documents in collection
                     // Note: Client side deletion requires iterating docs
                     try {
                         const snapshot = await getDocs(getOrdersCollectionRef());
                         const deletePromises = snapshot.docs.map(d => deleteDoc(d.ref));
                         await Promise.all(deletePromises);
                     } catch(e) {
                         console.error(e);
                         window.showModal("éŒ¯èª¤", "æ¸…é™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", "error");
                     }
                }
            );
        }

        window.copyAllOrders = function() {
            if (submittedOrders.length === 0) {
                window.showModal("æç¤º", "ç›®å‰æ²’æœ‰ä»»ä½•è¨‚å–®å¯è¤‡è£½", "info");
                return;
            }

            let text = `ã€å¶éµåšåš - ç¢§è¯åœ‹ä¸­æ•™å‹™è™•åˆé¤åœ˜ã€‘\n`;
            text += `æ—¥æœŸ: ${document.getElementById('currentDate').innerText}\n`;
            text += `----------------------\n`;

            submittedOrders.forEach((order, index) => {
                let itemsStr = order.items.map(i => `${i.name}x${i.count}`).join(', ');
                let noteStr = order.note ? ` (å‚™è¨»: ${order.note})` : '';
                text += `${index + 1}. ${order.name}: ${itemsStr}${noteStr} ($${order.total})\n`;
            });

            const grandTotal = document.getElementById('grandTotal').innerText;
            text += `----------------------\n`;
            text += `ç¸½é‡‘é¡: $${grandTotal}\n`;
            text += `çµ±è¨ˆæ™‚é–“: ${new Date().toLocaleTimeString('zh-TW', {hour: '2-digit', minute:'2-digit'})}\n`;
            text += `By Arthur WU`;

            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if(successful) {
                    window.showModal("è¤‡è£½æˆåŠŸ", "âœ… è¨‚å–®å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼<br>æ‚¨å¯ä»¥ç›´æ¥è²¼åˆ° Line ç¾¤çµ„ã€‚", "info");
                } else {
                    throw new Error("Copy failed");
                }
            } catch (err) {
                console.error('Fallback copy failed', err);
                window.showModal("è¤‡è£½å¤±æ•—", "ç€è¦½å™¨ä¸æ”¯æ´è‡ªå‹•è¤‡è£½ï¼Œè«‹æ‰‹å‹•æˆªåœ–æˆ–é¸å–æ–‡å­—ã€‚", "info");
            }

            document.body.removeChild(textArea);
        }
    </script>
</body>
</html>
